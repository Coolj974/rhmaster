{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Styles simples pour la gestion des frais kilométriques */
    .filter-card {
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e3e6f0;
        padding: 10px;
    }
    
    .filter-header {
        padding: 0.75rem 1rem;
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        font-weight: 600;
        color: #4e73df;
    }
    
    .expense-table {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 30px;
        font-weight: 600;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-rejected {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .expense-row {
        transition: background-color 0.2s;
    }
    
    .expense-row:hover {
        background-color: #f8f9fc;
    }
    
    .action-buttons {
        white-space: nowrap;
    }
    
    .action-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    .btn-view {
        color: #4e73df;
        background-color: #eaecf4;
        border-color: #eaecf4;
    }
    
    .btn-approve {
        color: #fff;
        background-color: #1cc88a;
        border-color: #1cc88a;
    }
    
    .btn-reject {
        color: #fff;
        background-color: #e74a3b;
        border-color: #e74a3b;
    }
    
    .expense-details {
        background-color: #f8f9fc;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #d1d3e2;
    }
    
    #map-view {
        height: 300px;
        width: 100%;
        border-radius: 0.5rem;
        margin-top: 1rem;
    }
    
    .vehicle-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        margin-right: 0.5rem;
    }
    
    .vehicle-car {
        background-color: #e8f0fe;
        color: #4285f4;
    }
    
    .vehicle-motorbike {
        background-color: #fce8e6;
        color: #ea4335;
    }
    
    .vehicle-electric {
        background-color: #e6f4ea;
        color: #34a853;
    }
    
    .vehicle-bicycle {
        background-color: #fef6e0;
        color: #fbbc04;
    }
    
    .card-stat {
        overflow: hidden;
        position: relative;
    }
    
    .card-stat .stat-icon {
        position: absolute;
        right: -10px;
        top: 20px;
        opacity: 0.1;
        font-size: 6rem;
        transform: rotate(15deg);
        transition: all 0.3s ease;
    }
    
    .kilometric-expense-table thead th {
        font-weight: 500;
        background-color: #f8f9fc;
        border-top: none;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .expense-row {
        transition: all 0.2s ease;
    }
    
    .expense-row:hover {
        background-color: #f0f4f8;
        transform: translateX(3px);
    }
</style>

<!-- Leaflet CSS pour la carte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- En-tête avec titre et actions -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-route me-2 text-primary"></i>Frais kilométriques
            </h1>
            <p class="text-muted mb-0 d-none d-md-block">Gérez les demandes de frais kilométriques</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Tableau de bord
            </a>
            <div class="dropdown">
                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-cog me-1"></i> Options
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-download me-2 text-primary"></i>Exporter</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-chart-pie me-2 text-success"></i>Statistiques</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Cartes de statistiques -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="dashboard-card card-stat border-start border-4 border-warning">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-xs text-uppercase fw-bold text-warning mb-1">En attente</div>
                            <div class="stat-value text-gray-800 mb-0">{{ pending_count }}</div>
                            <div class="mt-2 text-muted small">
                                <i class="fas fa-tasks me-1"></i> À traiter
                            </div>
                        </div>
                        <div class="rounded-circle p-3 bg-warning bg-opacity-10">
                            <i class="fas fa-hourglass-half fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Autres cartes statistiques similaires -->
        <div class="col-xl-3 col-md-6">
            <div class="dashboard-card card-stat border-start border-4 border-success">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-xs text-uppercase fw-bold text-success mb-1">Distance totale</div>
                            <div class="stat-value text-gray-800 mb-0">{{ total_distance|floatformat:0 }} <span class="fs-6">km</span></div>
                            <div class="mt-2 text-muted small">
                                <i class="fas fa-road me-1"></i> Mois en cours
                            </div>
                        </div>
                        <div class="rounded-circle p-3 bg-success bg-opacity-10">
                            <i class="fas fa-map-marked-alt fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="dashboard-card card-stat border-start border-4 border-danger">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-xs text-uppercase fw-bold text-danger mb-1">Remboursement</div>
                            <div class="stat-value text-gray-800 mb-0">{{ total_amount|floatformat:2 }} <span class="fs-6">€</span></div>
                            <div class="mt-2 text-muted small">
                                <i class="fas fa-euro-sign me-1"></i> Total à payer
                            </div>
                        </div>
                        <div class="rounded-circle p-3 bg-danger bg-opacity-10">
                            <i class="fas fa-receipt fa-2x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="dashboard-card card-stat border-start border-4 border-info">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-xs text-uppercase fw-bold text-info mb-1">Moyenne</div>
                            <div class="stat-value text-gray-800 mb-0">{{ average_distance|floatformat:0 }} <span class="fs-6">km</span></div>
                            <div class="mt-2 text-muted small">
                                <i class="fas fa-tachometer-alt me-1"></i> Par demande
                            </div>
                        </div>
                        <div class="rounded-circle p-3 bg-info bg-opacity-10">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des frais kilométriques -->
    <div class="card shadow mb-4 rounded-4 border-0">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white rounded-top">
            <div class="d-flex align-items-center">
                <span class="position-relative me-3">
                    <i class="fas fa-route fa-2x text-primary"></i>
                    {% if pending_count %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ pending_count }}
                    </span>
                    {% endif %}
                </span>
                <div>
                    <h5 class="m-0 font-weight-bold text-primary">Frais kilométriques en attente</h5>
                    <p class="text-muted small mb-0">Demandes qui nécessitent votre approbation</p>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            {% if expenses %}
                <div class="table-responsive">
                    <table class="table table-hover kilometric-expense-table align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Employé</th>
                                <th>Date</th>
                                <th>Trajet</th>
                                <th>Distance</th>
                                <th>Véhicule</th>
                                <th>Montant</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses %}
                                <tr class="expense-row">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2">
                                                <div class="user-bubble bg-primary text-white">
                                                    {{ expense.user.username|first|upper }}
                                                </div>
                                            </div>
                                            <div>
                                                <div class="fw-medium">{{ expense.user.get_full_name|default:expense.user.username }}</div>
                                                <div class="text-muted small">{{ expense.user.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ expense.date|date:"d/m/Y" }}</td>
                                    <td>
                                        <div class="small">
                                            <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                            {{ expense.departure|default:"Non spécifié"|truncatechars:20 }}
                                            <i class="fas fa-arrow-right mx-1 text-muted"></i>
                                            <i class="fas fa-flag-checkered text-success me-1"></i>
                                            {{ expense.arrival|default:"Non spécifié"|truncatechars:20 }}
                                        </div>
                                    </td>
                                    <td>{{ expense.distance|default:0|floatformat:2 }} km</td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            <i class="fas fa-car me-1"></i>
                                            {{ expense.get_vehicle_type_display }}
                                        </span>
                                    </td>
                                    <td>{{ expense.amount|default:0|floatformat:2 }} €</td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary view-expense" 
                                                    data-bs-toggle="modal" data-bs-target="#viewModal{{ expense.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if expense.status == 'pending' %}
                                                <a href="{% url 'approve_kilometric_expense' expense.id %}" 
                                                   class="btn btn-sm btn-outline-success"
                                                   onclick="return confirm('Voulez-vous approuver cette demande ?')">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                                <a href="{% url 'reject_kilometric_expense' expense.id %}"
                                                   class="btn btn-sm btn-outline-danger"
                                                   onclick="return confirm('Voulez-vous rejeter cette demande ?')">
                                                    <i class="fas fa-times"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-check-circle text-success"></i>
                    <h4>Aucune demande à traiter</h4>
                    <p class="text-muted">Il n'y a actuellement aucun frais kilométrique à valider.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modals pour les actions -->
<!-- ... Les modals pour voir les détails, approuver et rejeter ... -->

{% endblock %}

{% block extra_scripts %}
<!-- Leaflet JS pour la carte -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Afficher/masquer les détails des frais kilométriques
    const viewButtons = document.querySelectorAll('.view-details');
    const maps = {};
    
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const expenseId = this.getAttribute('data-expense-id');
            const detailsRow = document.getElementById(`details-${expenseId}`);
            
            if (detailsRow.style.display === 'none') {
                detailsRow.style.display = 'table-row';
                this.innerHTML = '<i class="fas fa-chevron-up"></i>';
                
                // Initialiser la carte quand on ouvre les détails
                setTimeout(() => {
                    initMap(expenseId);
                }, 100); // Petit délai pour s'assurer que le conteneur est affiché
            } else {
                detailsRow.style.display = 'none';
                this.innerHTML = '<i class="fas fa-eye"></i>';
            }
        });
    });
    
    // Initialiser une carte pour un trajet spécifique
    function initMap(expenseId) {
        const mapContainer = document.getElementById(`map-${expenseId}`);
        if (!mapContainer) return;
        
        // Si la carte existe déjà, pas besoin de la réinitialiser
        if (maps[expenseId]) return;
        
        // Créer la carte
        const map = L.map(`map-${expenseId}`).setView([-21.1151, 55.5364], 10); // Centré sur La Réunion par défaut
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        
        // Récupérer les coordonnées de départ et d'arrivée depuis les attributs data
        const departLat = parseFloat(mapContainer.getAttribute('data-depart-lat')) || -21.1151;
        const departLng = parseFloat(mapContainer.getAttribute('data-depart-lng')) || 55.5364;
        const arrivalLat = parseFloat(mapContainer.getAttribute('data-arrival-lat')) || -21.1310;
        const arrivalLng = parseFloat(mapContainer.getAttribute('data-arrival-lng')) || 55.4733;
        
        // Ajouter les marqueurs
        const departMarker = L.marker([departLat, departLng]).addTo(map);
        departMarker.bindPopup('<b>Départ</b>').openPopup();
        
        const arrivalMarker = L.marker([arrivalLat, arrivalLng]).addTo(map);
        arrivalMarker.bindPopup('<b>Arrivée</b>');
        
        // Tracer une ligne simple entre les deux points
        const routeLine = L.polyline([[departLat, departLng], [arrivalLat, arrivalLng]], {
            color: 'blue',
            weight: 3,
            opacity: 0.7
        }).addTo(map);
        
        // Ajuster la vue pour montrer tout l'itinéraire
        map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
        
        // Stocker la référence à la carte
        maps[expenseId] = map;
    }
    
    // Validation des dates
    const dateFromInput = document.getElementById('date_from');
    const dateToInput = document.getElementById('date_to');
    
    function validateDateRange() {
        const dateFrom = dateFromInput.value ? new Date(dateFromInput.value) : null;
        const dateTo = dateToInput.value ? new Date(dateToInput.value) : null;
        
        if (dateFrom && dateTo && dateFrom > dateTo) {
            dateToInput.setCustomValidity('La date de fin doit être postérieure à la date de début');
        } else {
            dateToInput.setCustomValidity('');
        }
    }
    
    if (dateFromInput && dateToInput) {
        dateFromInput.addEventListener('change', validateDateRange);
        dateToInput.addEventListener('change', validateDateRange);
    }
    
    // Validation des distances
    const minDistanceInput = document.getElementById('min_distance');
    const maxDistanceInput = document.getElementById('max_distance');
    
    function validateDistanceRange() {
        const minDistance = minDistanceInput.value ? parseFloat(minDistanceInput.value) : null;
        const maxDistance = maxDistanceInput.value ? parseFloat(maxDistanceInput.value) : null;
        
        if (minDistance !== null && maxDistance !== null && minDistance > maxDistance) {
            maxDistanceInput.setCustomValidity('La distance maximum doit être supérieure à la distance minimum');
        } else {
            maxDistanceInput.setCustomValidity('');
        }
    }
    
    if (minDistanceInput && maxDistanceInput) {
        minDistanceInput.addEventListener('change', validateDistanceRange);
        maxDistanceInput.addEventListener('change', validateDistanceRange);
    }
    
    // Fonction pour visualiser les détails
    const viewButtons = document.querySelectorAll('.view-expense');
    viewButtons.forEach(button => {
        button.addEventListener('click', function() {
            const expenseId = this.getAttribute('data-expense-id');
            // Afficher le modal avec les détails
        });
    });

    // Fonction pour approuver
    const approveButtons = document.querySelectorAll('.approve-expense');
    approveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const expenseId = this.getAttribute('data-expense-id');
            if (confirm('Voulez-vous approuver cette demande ?')) {
                window.location.href = `/kilometric/approve/${expenseId}/`;
            }
        });
    });

    // Fonction pour rejeter
    const rejectButtons = document.querySelectorAll('.reject-expense');
    rejectButtons.forEach(button => {
        button.addEventListener('click', function() {
            const expenseId = this.getAttribute('data-expense-id');
            if (confirm('Voulez-vous rejeter cette demande ?')) {
                window.location.href = `/kilometric/reject/${expenseId}/`;
            }
        });
    });
});
</script>
{% endblock %}
