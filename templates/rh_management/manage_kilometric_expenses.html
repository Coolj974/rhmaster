{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Styles pour la gestion des frais kilométriques */
    .expense-header {
        padding: 1rem 0;
        margin-bottom: 1.5rem;
    }
    
    .stats-card {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        height: 100%;
        border: none;
        overflow: hidden;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    
    .stats-card .card-body {
        padding: 1.5rem;
    }
    
    .stats-header {
        margin-bottom: 1rem;
        color: #5a5c69;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    
    .stats-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        line-height: 1;
    }
    
    .stats-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .trip-table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0.15rem 1.25rem rgba(0,0,0,0.075);
    }
    
    .trip-table th {
        background-color: #f8f9fc;
        font-weight: 600;
        padding: 1rem;
        border-top: none;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.35rem 0.85rem;
        border-radius: 30px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-pending {
        background-color: rgba(246, 194, 62, 0.15);
        color: #f6c23e;
    }
    
    .status-approved {
        background-color: rgba(28, 200, 138, 0.15);
        color: #1cc88a;
    }
    
    .status-rejected {
        background-color: rgba(231, 74, 59, 0.15);
        color: #e74a3b;
    }
    
    .trip-row {
        transition: all 0.3s ease;
    }
    
    .trip-row:hover {
        transform: translateX(5px);
        background-color: rgba(78, 115, 223, 0.05);
    }
    
    .action-buttons {
        white-space: nowrap;
    }
    
    .action-btn {
        transition: all 0.2s ease;
        margin: 0 2px;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-btn:hover {
        transform: scale(1.1);
    }
    
    .btn-group-actions {
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }
    
    .trip-row:hover .btn-group-actions {
        opacity: 1;
    }
    
    /* Améliorations pour le modal */
    .modal-header {
        background-color: #4e73df;
        color: #fff;
        border-bottom: none;
    }
    
    .modal-header .btn-close {
        color: white;
    }
    
    .modal-footer {
        border-top: none;
        padding: 1rem 1.5rem 1.5rem;
    }
    
    .modal-card {
        border-radius: 8px;
        box-shadow: 0 0.15rem 0.5rem rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
    }
    
    /* État vide */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }
    
    .empty-icon {
        font-size: 4rem;
        color: #dddfeb;
        margin-bottom: 1.5rem;
    }
    
    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-up {
        animation: slideUp 0.5s ease forwards;
    }
      /* Styles de la carte */
    #trip-map {
        height: 300px;
        border-radius: 8px;
        box-shadow: 0 0.15rem 0.5rem rgba(0, 0, 0, 0.1);
    }
    
    #map-container, .trip-map {
        height: 300px;
        border-radius: 8px;
        box-shadow: 0 0.15rem 0.5rem rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
        min-height: 250px;
        width: 100%;
    }
    
    /* Fix pour les cartes dans les modales */
    .modal.show .trip-map {
        display: block !important;
        visibility: visible !important;
        height: 300px !important;
    }
    
    .user-bubble {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    /* Filtres et recherche */
    .filters-card {
        border-radius: 10px;
        box-shadow: 0 0.15rem 1.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .filters-header {
        padding: 1rem 1.25rem;
        background-color: #f8f9fc;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .filters-body {
        padding: 1.25rem;
    }
    
    /* Styles pour les points de route */
    .route-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }
    
    .route-dot.start {
        background-color: #1cc88a;
    }
    
    .route-dot.end {
        background-color: #e74a3b;
    }
    
    .route-path {
        position: relative;
        padding-left: 20px;
    }
    
    .route-path:before {
        content: '';
        position: absolute;
        left: 5px;
        top: 18px;
        bottom: 0;
        width: 2px;
        background-color: #e3e6f0;
        height: calc(100% - 18px);
    }
    
    .route-path:last-child:before {
        display: none;
    }
    
    .print-only {
        display: none;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="container py-4">
    <!-- En-tête de la page -->
    <div class="d-sm-flex align-items-center justify-content-between expense-header">
        <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-route me-2"></i>Gestion des frais kilométriques</h1>
        <div>
            <a href="{% url 'export_kilometric_expenses' %}" class="btn btn-success shadow-sm me-2">
                <i class="fas fa-file-export me-1"></i> Exporter
            </a>
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary shadow-sm">
                <i class="fas fa-arrow-left me-1"></i> Tableau de bord
            </a>
        </div>
    </div>

    {% if messages %}
    <div class="mb-4 fade-in">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'danger' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Statistiques des frais kilométriques -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stats-header text-primary">TOTAL TRAJETS</div>
                            <div class="stats-value">{{ stats.total_count|default:"0" }}</div>
                            <div class="text-xs text-muted">trajets déclarés</div>
                        </div>
                        <div class="col-auto">
                            <div class="stats-icon bg-primary bg-opacity-10 text-primary">
                                <i class="fas fa-route"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stats-header text-warning">EN ATTENTE</div>
                            <div class="stats-value">{{ stats.pending_count|default:"0" }}</div>
                            <div class="text-xs text-muted">trajets à valider</div>
                        </div>
                        <div class="col-auto">
                            <div class="stats-icon bg-warning bg-opacity-10 text-warning">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stats-header text-success">DISTANCE TOTALE</div>
                            <div class="stats-value">{{ stats.total_distance|default:"0" }} <span class="small">km</span></div>
                            <div class="text-xs text-muted">tous trajets confondus</div>
                        </div>
                        <div class="col-auto">
                            <div class="stats-icon bg-success bg-opacity-10 text-success">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stats-header text-info">MONTANT TOTAL</div>
                            <div class="stats-value">{{ stats.total_amount|default:"0.00"|floatformat:2 }}€</div>
                            <div class="text-xs text-muted">à rembourser</div>
                        </div>
                        <div class="col-auto">
                            <div class="stats-icon bg-info bg-opacity-10 text-info">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filters-card">
        <div class="filters-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary"><i class="fas fa-filter me-2"></i>Filtres</h5>
            <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
                <i class="fas fa-chevron-down filter-toggle-icon"></i>
                <span class="filter-toggle-text ms-1">Afficher</span>
            </button>
        </div>
        <div class="collapse" id="filtersCollapse">
            <div class="filters-body">
                <form method="get" action="{% url 'manage_kilometric_expenses' %}" id="filters-form" class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <div class="form-floating">
                            <select name="status" id="statusFilter" class="form-select rounded-3">
                                <option value="">Tous les statuts</option>
                                <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>En attente</option>
                                <option value="approved" {% if filters.status == 'approved' %}selected{% endif %}>Approuvés</option>
                                <option value="rejected" {% if filters.status == 'rejected' %}selected{% endif %}>Rejetés</option>
                            </select>
                            <label for="statusFilter">Statut</label>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="form-floating">
                            <select name="user" id="userFilter" class="form-select rounded-3">
                                <option value="">Tous les employés</option>
                                {% for user in all_users %}
                                    <option value="{{ user.id }}" {% if filters.user_id == user.id %}selected{% endif %}>
                                        {{ user.get_full_name|default:user.username }}
                                    </option>
                                {% endfor %}
                            </select>
                            <label for="userFilter">Employé</label>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="form-floating">
                            <select name="vehicle_type" id="vehicleFilter" class="form-select rounded-3">
                                <option value="">Tous les véhicules</option>
                                <option value="car" {% if filters.vehicle_type == 'car' %}selected{% endif %}>Voiture</option>
                                <option value="electric_car" {% if filters.vehicle_type == 'electric_car' %}selected{% endif %}>Voiture électrique</option>
                                <option value="motorbike" {% if filters.vehicle_type == 'motorbike' %}selected{% endif %}>Moto</option>
                            </select>
                            <label for="vehicleFilter">Type de véhicule</label>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="form-floating">
                            <input type="text" class="form-control rounded-3" id="projectFilter" name="project" value="{{ filters.project|default:'' }}">
                            <label for="projectFilter">Projet</label>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="form-floating">
                            <input type="date" class="form-control rounded-3" id="startDateFilter" name="start_date" value="{{ filters.start_date|date:'Y-m-d'|default:'' }}">
                            <label for="startDateFilter">Date début</label>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="form-floating">
                            <input type="date" class="form-control rounded-3" id="endDateFilter" name="end_date" value="{{ filters.end_date|date:'Y-m-d'|default:'' }}">
                            <label for="endDateFilter">Date fin</label>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="form-floating">
                            <input type="text" class="form-control rounded-3" id="locationFilter" name="location" value="{{ filters.location|default:'' }}">
                            <label for="locationFilter">Lieu (départ/arrivée)</label>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="form-floating">
                            <select name="sort_by" id="sortByFilter" class="form-select rounded-3">
                                <option value="date" {% if filters.sort_by == 'date' %}selected{% endif %}>Date du trajet</option>
                                <option value="created_at" {% if filters.sort_by == 'created_at' %}selected{% endif %}>Date de création</option>
                                <option value="distance" {% if filters.sort_by == 'distance' %}selected{% endif %}>Distance</option>
                                <option value="amount" {% if filters.sort_by == 'amount' %}selected{% endif %}>Montant</option>
                            </select>
                            <label for="sortByFilter">Trier par</label>
                        </div>
                    </div>
                    
                    <div class="col-12 text-end">
                        <button type="reset" class="btn btn-outline-secondary">
                            <i class="fas fa-undo-alt me-1"></i> Réinitialiser
                        </button>
                        <button type="submit" class="btn btn-primary ms-2">
                            <i class="fas fa-filter me-1"></i> Appliquer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Frais kilométriques en attente -->
    <div class="card shadow-sm mb-4 rounded-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white rounded-top">
            <div class="d-flex align-items-center">
                <span class="position-relative me-2">
                    <i class="fas fa-clock fa-lg text-warning"></i>
                    {% if pending_expenses %}
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        {{ pending_expenses|length }}
                    </span>
                    {% endif %}
                </span>
                <h5 class="m-0 font-weight-bold text-primary">Frais kilométriques en attente</h5>
            </div>
            <div>
                {% if pending_expenses %}
                <a href="{% url 'approve_all_kilometric_expenses' %}" class="btn btn-sm btn-success me-2" onclick="return confirm('Êtes-vous sûr de vouloir approuver tous les frais kilométriques en attente ?')">
                    <i class="fas fa-check-double me-1"></i> Tout approuver
                </a>
                {% endif %}
                <button type="button" class="btn btn-sm btn-outline-primary" id="refreshTable">
                    <i class="fas fa-sync-alt me-1"></i> Actualiser
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            {% if pending_expenses %}
                <div class="table-responsive">
                    <table class="table table-hover trip-table align-middle mb-0" id="pendingTripsTable">
                        <thead>
                            <tr>
                                <th class="ps-3">Date</th>
                                <th>Employé</th>
                                <th>Trajet</th>
                                <th>Distance</th>
                                <th>Véhicule</th>
                                <th>Projet</th>
                                <th class="text-end">Montant</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in pending_expenses %}
                                <tr class="trip-row">
                                    <td class="ps-3">{{ expense.date|date:"d/m/Y" }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-bubble bg-primary text-white me-2">
                                                {{ expense.user.get_full_name|default:expense.user.username|slice:":1"|upper }}
                                            </div>
                                            <div>{{ expense.user.get_full_name|default:expense.user.username }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small route-path">
                                            <span class="route-dot start"></span>{{ expense.departure|truncatechars:20 }}
                                        </div>
                                        <div class="small route-path">
                                            <span class="route-dot end"></span>{{ expense.arrival|truncatechars:20 }}
                                        </div>
                                    </td>
                                    <td>{{ expense.distance }} km</td>
                                    <td><span class="badge bg-light text-dark">{{ expense.get_vehicle_type_display }}</span></td>
                                    <td>{{ expense.project|default:"-" }}</td>
                                    <td class="text-end fw-bold">{{ expense.amount|floatformat:2 }} €</td>
                                    <td>
                                        <div class="btn-group-actions d-flex justify-content-center">
                                            <button type="button" class="btn btn-sm btn-outline-info me-1 view-trip" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#detailsModal{{ expense.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success me-1 approve-trip" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#approveModal{{ expense.id }}">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger reject-trip" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#rejectModal{{ expense.id }}">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 view-map-btn" 
                                                    data-id="{{ expense.id }}" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#viewMapModal">
                                                <i class="fas fa-map"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- Modal pour voir les détails -->
                                <div class="modal fade" id="detailsModal{{ expense.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Détails du trajet</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row mb-4">
                                                    <div class="col-md-6">
                                                        <div class="card shadow-sm mb-3">
                                                            <div class="card-header bg-light">
                                                                <h6 class="mb-0">Informations générales</h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <p><strong>Employé:</strong> {{ expense.user.get_full_name|default:expense.user.username }}</p>
                                                                <p><strong>Date du trajet:</strong> {{ expense.date|date:"d/m/Y" }}</p>
                                                                <p><strong>Description:</strong> {{ expense.description }}</p>
                                                                {% if expense.project %}
                                                                    <p><strong>Projet:</strong> {{ expense.project }}</p>
                                                                {% endif %}
                                                                {% if expense.comment %}
                                                                    <p><strong>Commentaire:</strong> {{ expense.comment }}</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card shadow-sm mb-3">
                                                            <div class="card-header bg-light">
                                                                <h6 class="mb-0">Détails du véhicule et coût</h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <p><strong>Type de véhicule:</strong> {{ expense.get_vehicle_type_display }}</p>
                                                                <p><strong>Puissance fiscale:</strong> {{ expense.get_fiscal_power_display }}</p>
                                                                <p><strong>Distance:</strong> {{ expense.distance }} km</p>                                                                <p><strong>Taux appliqué:</strong> 
                                                                    {% if expense.fiscal_power == 'small' %}0.456
                                                                    {% elif expense.fiscal_power == 'medium' %}0.502
                                                                    {% elif expense.fiscal_power == 'large' %}0.603
                                                                    {% elif expense.fiscal_power == 'xlarge' %}0.653
                                                                    {% elif expense.fiscal_power == 'normal' %}0.502
                                                                    {% elif expense.fiscal_power == 'high' %}0.603
                                                                    {% elif expense.fiscal_power == 'electric' %}0.567
                                                                    {% elif expense.fiscal_power == 'motorbike' %}0.375
                                                                    {% endif %} € / km
                                                                </p>
                                                                <p><strong>Montant total:</strong> <span class="text-success fw-bold">{{ expense.amount|floatformat:2 }} €</span></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Carte du trajet -->
                                                <div class="card shadow-sm mb-3">
                                                    <div class="card-header bg-light">
                                                        <h6 class="mb-0">Carte du trajet</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="trip-map-{{ expense.id }}" class="trip-map" style="height: 300px;"></div>                                                        <script>
                                                            document.addEventListener('DOMContentLoaded', function() {
                                                                const mapId = 'trip-map-{{ expense.id }}';
                                                                
                                                                // Initialiser la carte quand le modal est affiché
                                                                $('#detailsModal{{ expense.id }}').on('shown.bs.modal', function() {
                                                                    console.log("Modal détail affiché, initialisation de la carte:", mapId);
                                                                    const mapElement = document.getElementById(mapId);
                                                                    
                                                                    if (!mapElement) {
                                                                        console.error("Élément carte non trouvé:", mapId);
                                                                        return;
                                                                    }
                                                                    
                                                                    // Redimensionner le conteneur avant d'initialiser la carte
                                                                    setTimeout(function() {
                                                                        initTripMap(
                                                                            mapElement, 
                                                                            {{ expense.departure_lat|default:"null" }}, 
                                                                            {{ expense.departure_lng|default:"null" }}, 
                                                                            {{ expense.arrival_lat|default:"null" }}, 
                                                                            {{ expense.arrival_lng|default:"null" }},
                                                                            "{{ expense.departure }}", 
                                                                            "{{ expense.arrival }}"
                                                                        );
                                                                    }, 100);
                                                                });
                                                            });
                                                        </script>
                                                        <div class="mt-3">
                                                            <div class="d-flex align-items-center mb-2">
                                                                <div class="route-dot start me-2"></div>
                                                                <div><strong>Départ:</strong> {{ expense.departure }}</div>
                                                            </div>
                                                            <div class="d-flex align-items-center">
                                                                <div class="route-dot end me-2"></div>
                                                                <div><strong>Arrivée:</strong> {{ expense.arrival }}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                                <div>
                                                    <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" 
                                                            data-bs-target="#approveModal{{ expense.id }}" data-bs-dismiss="modal">
                                                        <i class="fas fa-check me-1"></i> Approuver
                                                    </button>
                                                    <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                                            data-bs-target="#rejectModal{{ expense.id }}" data-bs-dismiss="modal">
                                                        <i class="fas fa-times me-1"></i> Rejeter
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Modal pour approuver -->
                                <div class="modal fade" id="approveModal{{ expense.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-success text-white">
                                                <h5 class="modal-title">Approuver le frais kilométrique</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form action="{% url 'kilometric_expense_action' expense.id %}" method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="approve">
                                                <div class="modal-body">
                                                    <div class="text-center mb-4">
                                                        <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                                                        <h5>Confirmer l'approbation</h5>
                                                        <p>Vous êtes sur le point d'approuver le trajet de <strong>{{ expense.distance }} km</strong> pour un montant de <strong>{{ expense.amount|floatformat:2 }} €</strong>.</p>
                                                        <div class="d-flex justify-content-center small text-muted">
                                                            <span>{{ expense.departure }} → {{ expense.arrival }}</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="form-floating mb-3">
                                                        <textarea class="form-control" id="approveComment{{ expense.id }}" name="comment" style="height: 100px" placeholder="Commentaire (optionnel)"></textarea>
                                                        <label for="approveComment{{ expense.id }}">Commentaire (optionnel)</label>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="fas fa-check-circle me-1"></i> Confirmer l'approbation
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Modal pour rejeter -->
                                <div class="modal fade" id="rejectModal{{ expense.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title">Rejeter le frais kilométrique</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form action="{% url 'kilometric_expense_action' expense.id %}" method="post">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="reject">
                                                <div class="modal-body">
                                                    <div class="text-center mb-4">
                                                        <i class="fas fa-times-circle text-danger fa-4x mb-3"></i>
                                                        <h5>Confirmer le rejet</h5>
                                                        <p>Vous êtes sur le point de rejeter le trajet de <strong>{{ expense.distance }} km</strong> pour un montant de <strong>{{ expense.amount|floatformat:2 }} €</strong>.</p>
                                                        <div class="d-flex justify-content-center small text-muted">
                                                            <span>{{ expense.departure }} → {{ expense.arrival }}</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="form-floating mb-3">
                                                        <textarea class="form-control" id="rejectComment{{ expense.id }}" name="comment" style="height: 100px" placeholder="Motif du rejet" required></textarea>
                                                        <label for="rejectComment{{ expense.id }}">Motif du rejet (requis)</label>
                                                        <div class="form-text text-danger">Veuillez expliquer pourquoi ce frais kilométrique est rejeté.</div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                                                    <button type="submit" class="btn btn-danger">
                                                        <i class="fas fa-times-circle me-1"></i> Confirmer le rejet
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <h4 class="mb-3">Tout est à jour !</h4>
                    <p class="text-muted mb-4">Il n'y a actuellement aucun frais kilométrique en attente de validation.</p>
                    <button id="refreshEmpty" class="btn btn-outline-primary">
                        <i class="fas fa-sync-alt me-1"></i> Actualiser
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Historique des frais kilométriques -->
    <div class="card shadow-sm mb-4 rounded-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white rounded-top">
            <div>
                <h5 class="m-0 font-weight-bold text-primary">Historique des frais kilométriques</h5>
            </div>
            <div>
                <select id="statusFilterHistoric" class="form-select form-select-sm d-inline-block w-auto me-2">
                    <option value="">Tous</option>
                    <option value="approved">Approuvés</option>
                    <option value="rejected">Rejetés</option>
                </select>
                <button type="button" class="btn btn-sm btn-outline-primary" id="refreshHistory">
                    <i class="fas fa-sync-alt me-1"></i> Actualiser
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            {% if all_expenses %}
                <div class="table-responsive">
                    <table class="table table-hover trip-table align-middle mb-0" id="allTripsTable">
                        <thead>
                            <tr>
                                <th class="ps-3">Date</th>
                                <th>Employé</th>
                                <th>Trajet</th>
                                <th>Distance</th>
                                <th>Véhicule</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in all_expenses %}
                                <tr class="trip-row {% if expense.status == 'pending' %}table-warning{% elif expense.status == 'rejected' %}table-danger{% endif %}">
                                    <td class="ps-3">{{ expense.date|date:"d/m/Y" }}</td>
                                    <td>{{ expense.user.get_full_name|default:expense.user.username }}</td>
                                    <td>
                                        <div class="small route-path">
                                            <span class="route-dot start"></span>{{ expense.departure|truncatechars:20 }}
                                        </div>
                                        <div class="small route-path">
                                            <span class="route-dot end"></span>{{ expense.arrival|truncatechars:20 }}
                                        </div>
                                    </td>
                                    <td>{{ expense.distance }} km</td>
                                    <td>{{ expense.get_vehicle_type_display }}</td>
                                    <td>{{ expense.amount|floatformat:2 }} €</td>
                                    <td>
                                        <span class="badge status-{{ expense.status }}">{{ expense.get_status_display }}</span>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-info view-trip" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#detailsHistoryModal{{ expense.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                
                                <!-- Modal pour voir les détails (historique) -->
                                <div class="modal fade" id="detailsHistoryModal{{ expense.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Détails du trajet</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <!-- Contenu similaire au modal de détails précédent -->
                                                <div class="row mb-4">
                                                    <div class="col-md-6">
                                                        <div class="card shadow-sm mb-3">
                                                            <div class="card-header bg-light">
                                                                <h6 class="mb-0">Informations générales</h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <p><strong>Employé:</strong> {{ expense.user.get_full_name|default:expense.user.username }}</p>
                                                                <p><strong>Date du trajet:</strong> {{ expense.date|date:"d/m/Y" }}</p>
                                                                <p><strong>Date de soumission:</strong> {{ expense.created_at|date:"d/m/Y H:i" }}</p>
                                                                <p><strong>Description:</strong> {{ expense.description }}</p>
                                                                <p><strong>Statut:</strong> 
                                                                    <span class="badge status-{{ expense.status }}">{{ expense.get_status_display }}</span>
                                                                </p>
                                                                {% if expense.status == 'rejected' and expense.comment %}
                                                                    <div class="alert alert-danger mt-2">
                                                                        <strong>Motif du rejet:</strong><br>
                                                                        {{ expense.comment }}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card shadow-sm mb-3">
                                                            <div class="card-header bg-light">
                                                                <h6 class="mb-0">Détails du trajet</h6>
                                                            </div>
                                                            <div class="card-body">
                                                                <p><strong>Véhicule:</strong> {{ expense.get_vehicle_type_display }}</p>
                                                                <p><strong>Distance:</strong> {{ expense.distance }} km</p>
                                                                <p><strong>Montant:</strong> {{ expense.amount|floatformat:2 }} €</p>
                                                                {% if expense.project %}
                                                                    <p><strong>Projet:</strong> {{ expense.project }}</p>
                                                                {% endif %}
                                                                {% if expense.comment and expense.status != 'rejected' %}
                                                                    <p><strong>Commentaire:</strong> {{ expense.comment }}</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Carte du trajet -->
                                                <div class="card shadow-sm mb-3">
                                                    <div class="card-header bg-light">
                                                        <h6 class="mb-0">Carte du trajet</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="history-map-{{ expense.id }}" class="trip-map" style="height: 300px;"></div>                                                        <script>
                                                            document.addEventListener('DOMContentLoaded', function() {
                                                                const mapId = 'history-map-{{ expense.id }}';
                                                                
                                                                $('#detailsHistoryModal{{ expense.id }}').on('shown.bs.modal', function() {
                                                                    console.log("Modal historique affiché, initialisation de la carte:", mapId);
                                                                    const mapElement = document.getElementById(mapId);
                                                                    
                                                                    if (!mapElement) {
                                                                        console.error("Élément carte historique non trouvé:", mapId);
                                                                        return;
                                                                    }
                                                                    
                                                                    // Redimensionner le conteneur avant d'initialiser la carte
                                                                    setTimeout(function() {
                                                                        initTripMap(
                                                                            mapElement, 
                                                                            {{ expense.departure_lat|default:"null" }}, 
                                                                            {{ expense.departure_lng|default:"null" }}, 
                                                                            {{ expense.arrival_lat|default:"null" }}, 
                                                                            {{ expense.arrival_lng|default:"null" }},
                                                                            "{{ expense.departure }}", 
                                                                            "{{ expense.arrival }}"
                                                                        );
                                                                    }, 100);
                                                                });
                                                            });
                                                        </script>
                                                        <div class="mt-3">
                                                            <div class="d-flex align-items-center mb-2">
                                                                <div class="route-dot start me-2"></div>
                                                                <div><strong>Départ:</strong> {{ expense.departure }}</div>
                                                            </div>
                                                            <div class="d-flex align-items-center">
                                                                <div class="route-dot end me-2"></div>
                                                                <div><strong>Arrivée:</strong> {{ expense.arrival }}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if all_expenses.has_other_pages %}
                <div class="p-3">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if all_expenses.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if filters.query_string %}&{{ filters.query_string }}{% endif %}">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ all_expenses.previous_page_number }}{% if filters.query_string %}&{{ filters.query_string }}{% endif %}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            {% for i in all_expenses.paginator.page_range %}
                                {% if all_expenses.number == i %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ i }}</span>
                                    </li>
                                {% elif i > all_expenses.number|add:'-3' and i < all_expenses.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ i }}{% if filters.query_string %}&{{ filters.query_string }}{% endif %}">{{ i }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if all_expenses.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ all_expenses.next_page_number }}{% if filters.query_string %}&{{ filters.query_string }}{% endif %}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ all_expenses.paginator.num_pages }}{% if filters.query_string %}&{{ filters.query_string }}{% endif %}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
                
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    <h4 class="mb-3">Aucun frais kilométrique</h4>
                    <p class="text-muted mb-4">Il n'y a actuellement aucun frais kilométrique dans le système.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}

<!-- Modal pour visualiser un trajet sur la carte -->
<div class="modal fade" id="viewMapModal" tabindex="-1" aria-labelledby="viewMapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewMapModalLabel">Visualisation du trajet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <!-- Conteneur de la carte -->
                        <div id="map-container" style="height: 400px; border-radius: 8px;"></div>
                    </div>
                </div>
                <div class="trip-info mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2"><strong>Départ:</strong> <span id="map-departure"></span></div>
                            <div class="mb-2"><strong>Arrivée:</strong> <span id="map-arrival"></span></div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2"><strong>Distance:</strong> <span id="map-distance"></span> km</div>
                            <div class="mb-2"><strong>Montant:</strong> <span id="map-amount"></span> €</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

<script>
// Fonction pour initialiser la carte
function initializeMap(departure, arrival, departureLat, departureLng, arrivalLat, arrivalLng) {
    // Nettoyer la carte existante
    const mapContainer = document.getElementById('map-container');
    if (mapContainer._leaflet_id) {
        mapContainer._leaflet_id = null;
    }
    
    console.log("Initialisation de la carte principale avec:", departure, arrival);
    
    // Initialiser la carte
    const map = L.map('map-container').setView([46.603354, 1.888334], 5); // Vue centrée sur la France
    
    // Ajouter le layer de carte OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    // S'assurer que les coordonnées sont des nombres
    departureLat = parseFloat(departureLat);
    departureLng = parseFloat(departureLng);
    arrivalLat = parseFloat(arrivalLat);
    arrivalLng = parseFloat(arrivalLng);
    
    // Vérifier si les coordonnées sont valides
    const validDepartureCoords = !isNaN(departureLat) && !isNaN(departureLng);
    const validArrivalCoords = !isNaN(arrivalLat) && !isNaN(arrivalLng);
    
    // Utiliser des coordonnées par défaut si nécessaire
    const departurePoint = validDepartureCoords 
        ? L.latLng(departureLat, departureLng) 
        : L.latLng(48.864716, 2.349014); // Paris par défaut
    
    const arrivalPoint = validArrivalCoords 
        ? L.latLng(arrivalLat, arrivalLng) 
        : L.latLng(45.764043, 4.835659); // Lyon par défaut
    
    console.log("Points de départ et d'arrivée:", departurePoint, arrivalPoint);
    
    // Créer une icône personnalisée pour le point de départ
    const departureIcon = L.divIcon({
        html: '<i class="fas fa-circle text-success" style="font-size: 14px;"></i>',
        className: 'map-custom-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    // Créer une icône personnalisée pour le point d'arrivée
    const arrivalIcon = L.divIcon({
        html: '<i class="fas fa-circle text-danger" style="font-size: 14px;"></i>',
        className: 'map-custom-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    // Ajouter le marqueur de départ
    const departureMarker = L.marker(departurePoint, {
        icon: departureIcon
    }).addTo(map);
    
    // Ajouter le marqueur d'arrivée
    const arrivalMarker = L.marker(arrivalPoint, {
        icon: arrivalIcon
    }).addTo(map);
    
    // Ajouter des popups pour les marqueurs
    departureMarker.bindPopup('<strong>Départ</strong><br>' + departure);
    arrivalMarker.bindPopup('<strong>Arrivée</strong><br>' + arrival);
    
    // Calculer et afficher l'itinéraire si Leaflet Routing Machine est chargé
    if (typeof L.Routing !== 'undefined') {
        console.log("Utilisation de Leaflet Routing Machine pour l'itinéraire");
        const routingControl = L.Routing.control({
            waypoints: [
                departurePoint,
                arrivalPoint
            ],
            routeWhileDragging: false,
            lineOptions: {
                styles: [{ color: '#3388ff', weight: 6 }]
            },
            createMarker: function() { return null; }, // Pas de marqueurs par défaut
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1',
                profile: 'driving',
                language: 'fr'
            }),
            showAlternatives: false,
            fitSelectedRoutes: true
        }).addTo(map);
        
        // Masquer le panneau d'instructions d'itinéraire
        routingControl.hide();
    } else {
        console.warn("L.Routing n'est pas disponible, traçage d'une ligne simple");
        // Tracer une ligne simple entre les points
        L.polyline([departurePoint, arrivalPoint], {color: '#3388ff', weight: 6}).addTo(map);
        
        // Ajuster la vue manuellement
        const bounds = L.latLngBounds([departurePoint, arrivalPoint]);
        map.fitBounds(bounds, { padding: [50, 50] });
    }
    
    // Forcer une mise à jour de la taille de la carte après un court délai
    setTimeout(function() {
        console.log("Invalidation de la taille de la carte", mapElement.id);
        try {
            map.invalidateSize(true);
            
            // Ajuster la vue pour bien montrer les marqueurs
            const bounds = L.latLngBounds([departurePoint, arrivalPoint]);
            map.fitBounds(bounds, { padding: [50, 50] });
            
            // Vérifier si la carte est visible et a une taille non nulle
            const mapSize = map.getSize();
            console.log("Taille de la carte:", mapSize);
            if (mapSize.x === 0 || mapSize.y === 0) {
                console.warn("Carte de taille nulle, tentative de redimensionnement forcé");
                // Forcer une seconde mise à jour après un délai plus long
                setTimeout(function() {
                    map.invalidateSize(true);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }, 500);
            }
        } catch (e) {
            console.error("Erreur lors de l'invalidation de la taille de la carte:", e);
        }
    }, 200);
    
    return map;
}

// Fonction pour afficher la carte dans le modal
function showMapModal(id) {
    // Récupérer les données du trajet
    const expense = expenses.find(exp => exp.id === parseInt(id));
    if (!expense) {
        console.error("Frais kilométrique non trouvé avec l'ID:", id);
        return;
    }
    
    console.log("Affichage du modal pour le trajet:", expense);
    
    // Mettre à jour les informations du modal
    document.getElementById('viewMapModalLabel').textContent = 'Trajet du ' + expense.date;
    document.getElementById('map-departure').textContent = expense.departure;
    document.getElementById('map-arrival').textContent = expense.arrival;
    document.getElementById('map-distance').textContent = expense.distance;
    document.getElementById('map-amount').textContent = expense.amount.toFixed(2);
    
    // Afficher le modal
    const mapModal = new bootstrap.Modal(document.getElementById('viewMapModal'));
    mapModal.show();
    
    // Initialiser la carte après l'affichage du modal
    document.getElementById('viewMapModal').addEventListener('shown.bs.modal', function () {
        console.log("Modal carte principal affiché, initialisation de la carte");
        // Nettoyage préventif pour éviter les problèmes d'initialisation multiple
        const mapContainer = document.getElementById('map-container');
        if (mapContainer._leaflet_id) {
            console.log("Nettoyage de la carte existante avant réinitialisation");
            mapContainer._leaflet_id = null;
        }
        
        setTimeout(function() {
            initializeMap(
                expense.departure,
                expense.arrival,
                expense.departure_lat,
                expense.departure_lng,
                expense.arrival_lat,
                expense.arrival_lng
            );
        }, 100);
    }, { once: true });
}

// Liste des dépenses pour la carte (remplie dynamiquement)
const expenses = [
    {% for expense in expenses %}
    {
        id: {{ expense.id }},
        user: "{{ expense.user.get_full_name|default:expense.user.username|escapejs }}",
        date: "{{ expense.date|date:'d/m/Y' }}",
        departure: "{{ expense.departure|escapejs }}",
        arrival: "{{ expense.arrival|escapejs }}",
        departure_lat: {{ expense.departure_lat|default:"48.864716" }},
        departure_lng: {{ expense.departure_lng|default:"2.349014" }},
        arrival_lat: {{ expense.arrival_lat|default:"45.764043" }},
        arrival_lng: {{ expense.arrival_lng|default:"4.835659" }},
        distance: {{ expense.distance }},
        amount: {{ expense.amount }},
        vehicle_type: "{{ expense.vehicle_type }}",
        fiscal_power: "{{ expense.fiscal_power }}",
        status: "{{ expense.status }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Fonction pour initialiser une carte dans une modale de détails
function initTripMap(mapElement, departureLat, departureLng, arrivalLat, arrivalLng, departure, arrival) {
    console.log("Initialisation de la carte dans le modal de détails", mapElement ? mapElement.id : 'élément non défini');
    
    // Vérifier si l'élément existe
    if (!mapElement) {
        console.error("L'élément de carte n'existe pas");
        return;
    }
    
    // Nettoyer la carte existante si elle existe
    if (mapElement._leaflet_id) {
        console.log("Nettoyage de la carte existante");
        mapElement._leaflet_id = null;
    }
    
    // Initialiser la carte
    const map = L.map(mapElement.id).setView([46.603354, 1.888334], 5); // Vue centrée sur la France
    
    // Ajouter le layer de carte OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    // S'assurer que les coordonnées sont des nombres
    departureLat = parseFloat(departureLat);
    departureLng = parseFloat(departureLng);
    arrivalLat = parseFloat(arrivalLat);
    arrivalLng = parseFloat(arrivalLng);
    
    console.log("Départ coords:", departureLat, departureLng);
    console.log("Arrivée coords:", arrivalLat, arrivalLng);
    
    // Vérifier si les coordonnées sont valides
    const validDepartureCoords = !isNaN(departureLat) && !isNaN(departureLng);
    const validArrivalCoords = !isNaN(arrivalLat) && !isNaN(arrivalLng);
    
    // Utiliser des coordonnées par défaut si nécessaire
    const departurePoint = validDepartureCoords 
        ? L.latLng(departureLat, departureLng) 
        : L.latLng(48.864716, 2.349014); // Paris par défaut
    
    const arrivalPoint = validArrivalCoords 
        ? L.latLng(arrivalLat, arrivalLng) 
        : L.latLng(45.764043, 4.835659); // Lyon par défaut
    
    // Créer une icône personnalisée pour le point de départ
    const departureIcon = L.divIcon({
        html: '<i class="fas fa-circle text-success" style="font-size: 14px;"></i>',
        className: 'map-custom-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    // Créer une icône personnalisée pour le point d'arrivée
    const arrivalIcon = L.divIcon({
        html: '<i class="fas fa-circle text-danger" style="font-size: 14px;"></i>',
        className: 'map-custom-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
    
    // Ajouter le marqueur de départ
    const departureMarker = L.marker(departurePoint, {
        icon: departureIcon
    }).addTo(map);
    
    // Ajouter le marqueur d'arrivée
    const arrivalMarker = L.marker(arrivalPoint, {
        icon: arrivalIcon
    }).addTo(map);
    
    // Ajouter des popups pour les marqueurs
    departureMarker.bindPopup('<strong>Départ</strong><br>' + departure);
    arrivalMarker.bindPopup('<strong>Arrivée</strong><br>' + arrival);
    
    // Calculer et afficher l'itinéraire si Leaflet Routing Machine est chargé
    if (typeof L.Routing !== 'undefined') {
        console.log("Utilisation de Leaflet Routing Machine pour l'itinéraire");
        const routingControl = L.Routing.control({
            waypoints: [
                departurePoint,
                arrivalPoint
            ],
            routeWhileDragging: false,
            lineOptions: {
                styles: [{ color: '#3388ff', weight: 6 }]
            },
            createMarker: function() { return null; }, // Pas de marqueurs par défaut
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1',
                profile: 'driving',
                language: 'fr'
            }),
            showAlternatives: false,
            fitSelectedRoutes: true
        }).addTo(map);
        
        // Masquer le panneau d'instructions d'itinéraire
        routingControl.hide();
    } else {
        console.warn("L.Routing n'est pas disponible, traçage d'une ligne simple");
        // Tracer une ligne simple entre les points
        L.polyline([departurePoint, arrivalPoint], {color: '#3388ff', weight: 6}).addTo(map);
        
        // Ajuster la vue manuellement
        const bounds = L.latLngBounds([departurePoint, arrivalPoint]);
        map.fitBounds(bounds, { padding: [50, 50] });
    }
    
    // Forcer une mise à jour de la taille de la carte après un court délai
    setTimeout(function() {
        console.log("Invalidation de la taille de la carte", mapElement.id);
        try {
            map.invalidateSize(true);
            
            // Ajuster la vue pour bien montrer les marqueurs
            const bounds = L.latLngBounds([departurePoint, arrivalPoint]);
            map.fitBounds(bounds, { padding: [50, 50] });
            
            // Vérifier si la carte est visible et a une taille non nulle
            const mapSize = map.getSize();
            console.log("Taille de la carte:", mapSize);
            if (mapSize.x === 0 || mapSize.y === 0) {
                console.warn("Carte de taille nulle, tentative de redimensionnement forcé");
                // Forcer une seconde mise à jour après un délai plus long
                setTimeout(function() {
                    map.invalidateSize(true);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }, 500);
            }
        } catch (e) {
            console.error("Erreur lors de l'invalidation de la taille de la carte:", e);
        }
    }, 200);
    
    // Ajouter un événement de redimensionnement pour ajuster la carte
    window.addEventListener('resize', function() {
        setTimeout(function() {
            map.invalidateSize();
        }, 200);
    });
    
    return map;
}

// Fonction pour précharger les ressources Leaflet
document.addEventListener('DOMContentLoaded', function() {
    console.log("Initialisation du préchargement de Leaflet et des événements");
    
    // Attacher l'événement aux boutons de visualisation
    document.querySelectorAll('.view-map-btn').forEach(button => {
        button.addEventListener('click', function() {
            const expenseId = this.getAttribute('data-id');
            console.log("Bouton de carte cliqué pour l'ID:", expenseId);
            showMapModal(expenseId);
        });
    });
    
    // Précharger les dépendances Leaflet Routing Machine si elles ne sont pas déjà chargées
    if (typeof L !== 'undefined' && typeof L.Routing === 'undefined') {
        console.log("Préchargement de Leaflet Routing Machine");
        const routingStyle = document.createElement('link');
        routingStyle.rel = 'stylesheet';
        routingStyle.href = 'https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css';
        document.head.appendChild(routingStyle);
        
        const routingScript = document.createElement('script');
        routingScript.src = 'https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js';
        document.head.appendChild(routingScript);
    }
    
    // Initialiser les événements des modales de détails
    document.querySelectorAll('[id^="detailsModal"]').forEach(modal => {
        modal.addEventListener('show.bs.modal', function(event) {
            console.log("Modale de détails en cours d'ouverture:", modal.id);
        });
    });
    
    // Initialiser les événements des modales d'historique
    document.querySelectorAll('[id^="detailsHistoryModal"]').forEach(modal => {
        modal.addEventListener('show.bs.modal', function(event) {
            console.log("Modale d'historique en cours d'ouverture:", modal.id);
        });
    });
});

// Fonction pour inspecter et réparer les conteneurs de carte
function checkMapContainers() {
    console.log("Vérification des conteneurs de carte...");
    
    // Vérifier tous les conteneurs de carte
    document.querySelectorAll('.trip-map, #map-container').forEach(container => {
        const computedStyle = window.getComputedStyle(container);
        console.log("Conteneur:", container.id, "Style calculé:", {
            display: computedStyle.display,
            visibility: computedStyle.visibility,
            height: computedStyle.height,
            width: computedStyle.width
        });
        
        // Forcer les styles si nécessaire
        if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden' || 
            computedStyle.height === '0px' || computedStyle.width === '0px') {
            console.warn("Conteneur caché ou de taille nulle, tentative de réparation:", container.id);
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.height = '300px';
            container.style.width = '100%';
        }
    });
}

// Vérifier les conteneurs après le chargement et quand une modale est affichée
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(checkMapContainers, 1000);
    
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            setTimeout(checkMapContainers, 100);
        });
    });
});

// Documentation des problèmes et des solutions pour la carte Leaflet
/*
Problèmes identifiés:
1. La fonction initTripMap() était appelée dans les modales mais n'était pas définie
2. Leaflet Routing Machine n'était pas correctement chargé
3. La carte ne se redimensionnait pas correctement dans les modales

Solutions implémentées:
1. Ajout de la fonction initTripMap()
2. Chargement de Leaflet Routing Machine et fallback si non disponible
3. Utilisation de map.invalidateSize() pour forcer la mise à jour de la taille
4. Ajout de logs pour faciliter le débogage
5. Vérification de l'existence des éléments DOM et des coordonnées valides
*/
</script>
{% endblock extra_scripts %}
