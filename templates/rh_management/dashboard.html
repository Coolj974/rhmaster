{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Variables CSS pour cohérence et facilité de maintenance */
    :root {
        --card-border-radius: 12px;
        --card-shadow: 0 2px 5px rgba(0,0,0,0.05);
        --card-hover-shadow: 0 5px 15px rgba(0,0,0,0.1);
        --primary-blue: #4e73df;
        --primary-blue-dark: #2e59d9;
        --primary-blue-light: rgba(78, 115, 223, 0.1);
        --secondary-color: #858796;
        --success-color: #1cc88a;
        --danger-color: #e74a3b;
        --warning-color: #f6c23e;
        --info-color: #36b9cc;
        --transition-speed: 0.3s;
        --card-spacing: 1.5rem;
    }
    
    /* Optimisation pour les appareils à haute densité de pixels */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .dashboard-container {
            text-rendering: optimizeLegibility;
        }
    }
    
    /* Préchargement pour les transitions */
    .dashboard-container * {
        backface-visibility: hidden;
    }
    
    /* Styles optimisés pour le dashboard avec support a11y */
    .dashboard-container {
        padding: 1.2rem 0;
        max-width: 1920px;
        margin: 0 auto;
        will-change: transform;
        contain: layout style; /* Optimisation pour le rendu */
    }
    
    .welcome-section {
        background: linear-gradient(135deg, #f8f9fa, #eaecf4);
        border-radius: var(--card-border-radius);
        padding: var(--card-spacing);
        margin-bottom: var(--card-spacing);
        box-shadow: var(--card-shadow);
        border-left: 4px solid var(--primary-blue);
        transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        will-change: transform, box-shadow;
        position: relative;
        overflow: hidden;
    }
    
    .welcome-section:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
    }
    
    /* Amélioration de l'accessibilité pour le focus */
    .action-link:focus, .btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.25);
    }
    
    /* Amélioration des animations avec hint pour le navigateur */
    .action-card {
        height: 100%;
        border: none;
        border-radius: var(--card-border-radius);
        overflow: hidden;
        transition: transform var(--transition-speed) ease, 
                    box-shadow var(--transition-speed) ease;
        box-shadow: var(--card-shadow);
        will-change: transform;
        background-color: #fff;
    }
    
    .action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .action-card .card-body {
        padding: var(--card-spacing);
        display: flex;
        flex-direction: column;
    }
    
    .action-card .icon-container {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }
    
    .action-card .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }
    
    .action-card .card-text {
        color: var(--secondary-color);
        flex-grow: 1;
        margin-bottom: 1.25rem;
    }
    
    .action-card .btn {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .action-card .btn:hover {
        transform: translateY(-2px);
    }
    
    /* Animation optimisée pour le panneau d'actions rapides */
    .dragging {
        cursor: grabbing !important;
        opacity: 0.92;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
        transition: none !important;
    }
    
    /* Styles pour les cartes de stats avec compteurs animés */
    .stats-card {
        border-radius: var(--card-border-radius);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        overflow: hidden;
        contain: content; /* Amélioration de la performance de rendu */
    }
    
    .stats-card:hover {
        transform: translateY(-3px);
    }
    
    .stat-item {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        display: flex;
        align-items: center;
        transition: all 0.2s;
        position: relative;
    }
    
    /* Indicateur visuel d'interaction */
    .stat-item::after {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: transparent;
        border-radius: 8px;
        transition: background-color 0.2s ease;
    }
    
    .stat-item:hover {
        background-color: #f8f9fc;
        transform: translateX(3px);
    }
    
    .stat-item:hover::after {
        background-color: rgba(78, 115, 223, 0.03);
    }
    
    .stat-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        margin-right: 1rem;
        position: relative;
        z-index: 1;
    }
    
    .stat-text {
        flex-grow: 1;
        position: relative;
        z-index: 1;
    }
    
    .stat-title {
        font-size: 0.85rem;
        color: var(--secondary-color);
        margin-bottom: 0.25rem;
    }
    
    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #3a3b45;
    }
    
    /* Animation optimisée pour les indicateurs d'activité */
    .activity-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        position: relative;
    }
    
    .activity-indicator.active {
        background-color: var(--success-color);
    }
    
    .activity-indicator.active::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: 50%;
        background-color: rgba(28, 200, 138, 0.5);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 0.8;
        }
        70% {
            transform: scale(1.7);
            opacity: 0;
        }
        100% {
            transform: scale(1.7);
            opacity: 0;
        }
    }
    
    /* Support tactile optimisé pour les badges animés */
    .badge-animated {
        transition: transform 0.2s ease;
    }
    
    .badge-animated.pulse {
        animation: badgePulse 0.5s ease;
    }
    
    @keyframes badgePulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Amélioration tactile pour les appareils mobiles */
    @media (max-width: 767.98px) {
        .welcome-section {
            padding: 1.2rem;
        }
        
        .action-card .card-body {
            padding: 1.2rem;
        }
        
        /* Optimisation de l'espace sur petit écran */
        .stats-card {
            margin-bottom: 1rem;
        }
        
        .stat-item {
            padding: 0.8rem;
        }
        
        /* Ajustements tactiles pour les badges */
        .badge {
            padding: 0.5rem 0.7rem; /* Plus grand pour toucher facilement */
        }
    }
    
    /* Améliorations de l'accessibilité pour le contraste */
    .alert {
        border-radius: 10px;
        border-left: 4px solid;
    }
    
    .alert-success {
        border-color: var(--success-color);
    }
    
    .alert-warning {
        border-color: var(--warning-color);
    }
    
    .alert-danger {
        border-color: var(--danger-color);
    }
    
    /* Améliorations pour la timeline et les notifications */
    .timeline {
        position: relative;
        padding-left: 1.5rem;
        margin: 0 0 0 30px;
        color: var(--secondary-color);
    }
    
    .timeline:before {
        content: ' ';
        background: #e3e6f0;
        display: inline-block;
        position: absolute;
        left: 0;
        width: 2px;
        height: 100%;
        z-index: 1;
    }
    
    .timeline-item {
        margin: 1.5rem 0;
        position: relative;
        opacity: 0;
        animation: fadeInUp 0.5s ease forwards;
    }
    
    .timeline-item:first-child {
        margin-top: 0;
    }
    
    /* Animation d'entrée pour les éléments de la timeline */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .timeline-item:nth-child(1) { animation-delay: 0.1s; }
    .timeline-item:nth-child(2) { animation-delay: 0.2s; }
    .timeline-item:nth-child(3) { animation-delay: 0.3s; }
    .timeline-item:nth-child(4) { animation-delay: 0.4s; }
    .timeline-item:nth-child(5) { animation-delay: 0.5s; }
    
    .timeline-item:before {
        content: ' ';
        background: white;
        display: inline-block;
        position: absolute;
        border-radius: 50%;
        left: -38px;
        width: 16px;
        height: 16px;
        z-index: 2;
        border: 2px solid var(--primary-blue);
        box-shadow: 0 0 0 4px rgba(78, 115, 223, 0.1);
        transition: box-shadow 0.3s ease;
    }
    
    .timeline-item:hover:before {
        box-shadow: 0 0 0 6px rgba(78, 115, 223, 0.2);
    }
    
    /* Optimisation des animations pour le quick actions panel */
    .quick-actions-floating {
        will-change: transform, box-shadow;
    }
    
    /* Accessibilité pour le focus dans le tableau */
    .table-hover tr:focus-within {
        background-color: rgba(78, 115, 223, 0.05);
    }
    
    /* Lazy-loading pour les images et contenus */
    img.lazy-load {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    img.lazy-load.loaded {
        opacity: 1;
    }
    
    /* Amélioration de l'affichage des tables pour les petits écrans */
    @media (max-width: 575.98px) {
        .table-responsive {
            border-radius: var(--card-border-radius);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        
        /* Indication qu'on peut scroller */
        .table-responsive:after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
            pointer-events: none;
            opacity: 0.8;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container dashboard-container">
    <div class="welcome-section">
        <div class="row align-items-center">
            <div class="col-md-7">
                <h4 class="mb-1">Bonjour, {{ request.user.first_name|default:request.user.username }} !</h4>
                <p class="text-muted mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>{{ today|date:"l j F Y" }}
                    <span class="mx-2">•</span>
                    <i class="fas fa-clock me-1"></i><span id="current-time">{{ now|time:"H:i:s" }}</span>
                </p>
                <hr class="my-3">                <p class="mb-0">
                    {% if pending_tasks_count > 0 %}
                        <span class="badge bg-warning text-dark me-2 badge-animated" data-badge-type="tasks">{{ pending_tasks_count }}</span>
                        <span class="text-dark">tâche{{ pending_tasks_count|pluralize }} en attente aujourd'hui</span>
                        {% if next_event %}
                        <span class="mx-2">•</span>
                        <i class="far fa-calendar-check me-1 text-primary"></i>
                        <span class="text-primary">{{ next_event }}</span>
                        {% endif %}
                    {% else %}
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <span class="text-dark">Votre journée est à jour</span>
                        {% if next_event %}
                        <span class="mx-2">•</span>
                        <i class="far fa-calendar-check me-1 text-primary"></i>
                        <span class="text-primary">{{ next_event }}</span>
                        {% endif %}
                    {% endif %}
                </p>
            </div>
            <div class="col-md-5 text-md-end mt-3 mt-md-0">
                <div class="d-flex justify-content-md-end flex-wrap gap-2">
                    <a href="{% url 'leave_request' %}" class="btn btn-sm btn-primary me-2 mb-2 mb-md-0">
                        <i class="fas fa-plus-circle me-1"></i> Demander un congé
                    </a>
                    <a href="{% url 'submit_expense' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-receipt me-1"></i> Note de frais
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'danger' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Actions principales pour tous les utilisateurs -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{% url 'leave_request' %}" class="action-link">
                <div class="card action-card">
                    <div class="card-body">
                        <div class="icon-container bg-primary bg-opacity-10 text-primary">
                            <i class="fas fa-calendar-plus"></i>
                        </div>
                        <h5 class="card-title">Demande de congé</h5>
                        <p class="card-text">Soumettez une nouvelle demande de congé ou consultez vos demandes existantes.</p>
                        <div class="d-grid">
                            <button class="btn btn-primary">
                                <i class="fas fa-plus-circle me-1"></i> Nouvelle demande
                            </button>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">            <a href="{% url 'my_leaves' %}" class="action-link">
                <div class="card action-card">
                    <div class="card-body">
                        <div class="icon-container bg-success bg-opacity-10 text-success">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h5 class="card-title">Mes congés</h5>
                        <p class="card-text">Consultez l'historique de vos congés et le solde de jours disponibles.</p>
                        <div class="d-flex gap-2">
                            <a href="{% url 'my_leaves' %}" class="btn btn-success flex-grow-1">
                                <i class="fas fa-list-ul me-1"></i> Voir mes congés
                            </a>
                            <a href="{% url 'leave_history' %}" class="btn btn-info">
                                <i class="fas fa-history me-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{% url 'submit_expense' %}" class="action-link">
                <div class="card action-card">
                    <div class="card-body">
                        <div class="icon-container bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h5 class="card-title">Note de frais</h5>
                        <p class="card-text">Soumettez une nouvelle note de frais pour vos dépenses professionnelles.</p>
                        <div class="d-grid">
                            <button class="btn btn-warning text-dark">
                                <i class="fas fa-receipt me-1"></i> Nouvelle note
                            </button>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">            <a href="{% url 'my_expenses' %}" class="action-link">
                <div class="card action-card">
                    <div class="card-body">
                        <div class="icon-container bg-info bg-opacity-10 text-info">
                            <i class="fas fa-search-dollar"></i>
                        </div>
                        <h5 class="card-title">Mes notes de frais</h5>
                        <p class="card-text">Consultez vos notes de frais existantes et leur statut actuel.</p>
                        <div class="d-flex gap-2">
                            <a href="{% url 'my_expenses' %}" class="btn btn-info flex-grow-1">
                                <i class="fas fa-list-ul me-1"></i> Voir mes notes
                            </a>
                            <a href="{% url 'expense_history' %}" class="btn btn-primary">
                                <i class="fas fa-history me-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Résumé visuel des statistiques -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stats-visual rounded-4 shadow-sm border-0 position-relative">
                <div class="row p-3">
                    <!-- Synthèse des congés -->
                    <div class="col-md-6 mb-3 mb-md-0">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-bubble bg-primary-subtle text-primary me-3">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <h5 class="mb-0 fw-bold">Synthèse des congés</h5>
                        </div>
                        
                        <div class="stat-card mb-4">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-medium">Solde disponible</span>
                                    <span class="badge-modern {% if leave_balance.available < 5 %}warning{% elif leave_balance.available < 2 %}danger{% else %}success{% endif %}">
                                        {{ leave_balance.available|default:"0" }} / {{ leave_balance.acquired|default:"0" }} jours
                                    </span>
                                </div>
                                <div class="progress-container">
                                    <div class="progress-bar 
                                        {% if leave_balance.available_percentage < 20 %}bg-danger
                                        {% elif leave_balance.available_percentage < 50 %}bg-warning
                                        {% else %}bg-primary{% endif %}" 
                                        style="width: {{ leave_balance.available_percentage|default:"0" }}%">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <span class="small">Utilisés: {{ leave_balance.taken|default:"0" }}</span>
                                    <span class="small fw-semibold {% if leave_balance.available_percentage < 30 %}text-danger{% elif leave_balance.available_percentage < 60 %}text-warning{% else %}text-success{% endif %}">
                                        {{ leave_balance.available_percentage|default:"0" }}% restant
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-4">
                                <div class="stat-counter success">
                                    <div class="counter-icon">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div class="counter-value">{{ stats.approved_count|default:"0" }}</div>
                                    <div class="counter-label">Approuvés</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-counter warning">
                                    <div class="counter-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="counter-value">{{ stats.pending_count|default:"0" }}</div>
                                    <div class="counter-label">En attente</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-counter danger">
                                    <div class="counter-icon">
                                        <i class="fas fa-times"></i>
                                    </div>
                                    <div class="counter-value">{{ stats.rejected_count|default:"0" }}</div>
                                    <div class="counter-label">Refusés</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes de frais -->
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-3">
                            <div class="icon-bubble bg-success-subtle text-success me-3">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <h5 class="mb-0 fw-bold">Notes de frais</h5>
                        </div>
                        
                        <div class="stat-card mb-4">
                            <div class="card-body p-3">
                                <div class="row">
                                    <div class="col-6 border-end">
                                        <div class="text-center p-2">
                                            <div class="small mb-1">Total soumis</div>
                                            <div class="h3 mb-0 fw-bold">{{ expenses_stats.total|default:"0" }}</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2">
                                            <div class="small mb-1">Remboursés</div>
                                            <div class="h3 mb-0 fw-bold text-success">
                                                <i class="fas fa-euro-sign fa-sm"></i> {{ expenses_stats.reimbursed|default:"0" }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-4">
                                <div class="stat-counter success">
                                    <div class="counter-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="counter-value">{{ expenses_stats.approved|default:"0" }}</div>
                                    <div class="counter-label">Approuvés</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-counter warning">
                                    <div class="counter-icon">
                                        <i class="fas fa-hourglass-half"></i>
                                    </div>
                                    <div class="counter-value">{{ expenses_stats.pending|default:"0" }}</div>
                                    <div class="counter-label">En attente</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-counter danger">
                                    <div class="counter-icon">
                                        <i class="fas fa-ban"></i>
                                    </div>
                                    <div class="counter-value">{{ expenses_stats.rejected|default:"0" }}</div>
                                    <div class="counter-label">Refusés</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional CSS for modern components -->
    <style>
        /* Modern styling for stat cards */
        .stat-card {
            border-radius: 12px;
            border: none;
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Icon bubble */
        .icon-bubble {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        /* Modern progress bar */
        .progress-container {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease-in-out;
        }
        
        /* Modern badges */
        .badge-modern {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .badge-modern.success {
            background-color: #e6f7f0;
            color: #0cb876;
        }
        
        .badge-modern.warning {
            background-color: #fff8e6;
            color: #f5a623;
        }
        
        .badge-modern.danger {
            background-color: #feeceb;
            color: #f64e60;
        }
        
        /* Modern counters */
        .stat-counter {
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            height: 100%;
        }
        
        .stat-counter:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }
        
        .counter-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 1.2rem;
        }
        
        .stat-counter.success .counter-icon {
            background-color: #e6f7f0;
            color: #0cb876;
        }
        
        .stat-counter.warning .counter-icon {
            background-color: #fff8e6;
            color: #f5a623;
        }
        
        .stat-counter.danger .counter-icon {
            background-color: #feeceb;
            color: #f64e60;
        }
        
        .counter-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .counter-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* Stats visual container */
        .stats-visual {
            background-color: #fff;
            transition: all 0.3s ease;
            padding: 1.5rem;
        }
    </style>    <!-- Section pour les demandes de congés en attente (pour les RH et admins) -->
    {% if is_hr or is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow h-100 rounded-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center bg-white rounded-top">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-clock fa-sm mr-2"></i> Demandes en attente
                    </h6>
                    <a href="{% url 'manage_leaves' %}" class="btn btn-sm btn-outline-primary">Voir tout</a>
                </div>
                <div class="card-body">                    <!-- Onglets -->
                    <ul class="nav nav-tabs mb-3" id="pendingTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="leaves-tab" data-bs-toggle="tab" data-bs-target="#leaves" type="button" role="tab">
                                Congés 
                                {% if pending_leaves_count > 0 %}
                                <span class="badge bg-danger ms-1 badge-animated" data-badge-type="leave">{{ pending_leaves_count }}</span>
                                {% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">
                                Frais 
                                {% if pending_expenses_count > 0 %}
                                <span class="badge bg-danger ms-1 badge-animated" data-badge-type="expense">{{ pending_expenses_count }}</span>
                                {% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="kilometrics-tab" data-bs-toggle="tab" data-bs-target="#kilometrics" type="button" role="tab">
                                Kilométrique 
                                {% if pending_kilometrics_count > 0 %}
                                <span class="badge bg-danger ms-1 badge-animated" data-badge-type="kilometric">{{ pending_kilometrics_count }}</span>
                                {% endif %}
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Contenu des onglets -->
                    <div class="tab-content">
                        <!-- Onglet Congés -->
                        <div class="tab-pane fade show active" id="leaves" role="tabpanel">
                            {% if pending_leaves %}
                                <div class="table-responsive">
                                    <table class="table leave-table">
                                        <thead>
                                            <tr>
                                                <th>Employé</th>
                                                <th>Période</th>
                                                <th>Type</th>
                                                <th>Durée</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for leave in pending_leaves|slice:":5" %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="me-2">
                                                                {% if leave.user.userprofile.profile_picture %}
                                                                    <img src="{{ leave.user.userprofile.profile_picture.url }}" class="rounded-circle" width="32" height="32">
                                                                {% else %}
                                                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                                                        {{ leave.user.username.0|upper }}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                            <div>
                                                                {{ leave.user.get_full_name|default:leave.user.username }}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="d-block">{{ leave.start_date|date:"d/m/Y" }}</span>
                                                        <small class="text-muted">au {{ leave.end_date|date:"d/m/Y" }}</small>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-light text-dark">{{ leave.get_leave_type_display }}</span>
                                                    </td>
                                                    <td>{{ leave.days_requested }} jour(s)</td>
                                                    <td>
                                                        <a href="{% url 'approve_leave' leave.id %}" class="btn btn-sm btn-success me-1">
                                                            <i class="fas fa-check"></i>
                                                        </a>
                                                        <a href="{% url 'reject_leave' leave.id %}" class="btn btn-sm btn-danger">
                                                            <i class="fas fa-times"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% if pending_leaves.count > 5 %}
                                    <div class="text-center mt-3">
                                        <a href="{% url 'manage_leaves' %}" class="btn btn-outline-primary">Voir toutes les demandes</a>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="far fa-calendar-check fa-3x mb-3 text-muted"></i>
                                    <p class="mb-0">Aucune demande de congé en attente.</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Onglet Notes de frais -->
                        <div class="tab-pane fade" id="expenses" role="tabpanel">
                            {% if pending_expenses %}
                                <div class="table-responsive">
                                    <table class="table leave-table">
                                        <thead>
                                            <tr>
                                                <th>Employé</th>
                                                <th>Date</th>
                                                <th>Description</th>
                                                <th>Montant</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for expense in pending_expenses|slice:":5" %}
                                                <tr>
                                                    <td>{{ expense.user.get_full_name|default:expense.user.username }}</td>
                                                    <td>{{ expense.date|date:"d/m/Y" }}</td>
                                                    <td>{{ expense.description|truncatechars:30 }}</td>
                                                    <td>{{ expense.amount }} €</td>
                                                    <td>
                                                        <a href="{% url 'approve_expense' expense.id %}" class="btn btn-sm btn-success me-1">
                                                            <i class="fas fa-check"></i>
                                                        </a>
                                                        <a href="{% url 'reject_expense' expense.id %}" class="btn btn-sm btn-danger">
                                                            <i class="fas fa-times"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% if pending_expenses.count > 5 %}
                                    <div class="text-center mt-3">
                                        <a href="{% url 'manage_expenses' %}" class="btn btn-outline-primary">Voir toutes les notes</a>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="far fa-file-invoice-dollar fa-3x mb-3 text-muted"></i>
                                    <p class="mb-0">Aucune note de frais en attente.</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Onglet Frais kilométriques -->
                        <div class="tab-pane fade" id="kilometrics" role="tabpanel">
                            {% if pending_kilometrics %}
                                <div class="table-responsive">
                                    <table class="table leave-table">
                                        <thead>
                                            <tr>
                                                <th>Employé</th>
                                                <th>Date</th>
                                                <th>Trajet</th>
                                                <th>Distance</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for km in pending_kilometrics|slice:":5" %}
                                                <tr>
                                                    <td>{{ km.user.get_full_name|default:km.user.username }}</td>
                                                    <td>{{ km.date|date:"d/m/Y" }}</td>
                                                    <td>{{ km.departure }} → {{ km.destination }}</td>
                                                    <td>{{ km.distance }} km</td>
                                                    <td>
                                                        <a href="{% url 'approve_kilometric_expense' km.id %}" class="btn btn-sm btn-success me-1">
                                                            <i class="fas fa-check"></i>
                                                        </a>
                                                        <a href="{% url 'reject_kilometric_expense' km.id %}" class="btn btn-sm btn-danger">
                                                            <i class="fas fa-times"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% if pending_kilometrics.count > 5 %}
                                    <div class="text-center mt-3">
                                        <a href="{% url 'manage_kilometric_expenses' %}" class="btn btn-outline-primary">Voir tous les frais</a>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="far fa-car fa-3x mb-3 text-muted"></i>
                                    <p class="mb-0">Aucun frais kilométrique en attente.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>        </div>
    </div>
    {% endif %}

    <!-- Actions rapides (draggable) avec animations et sauvegarde de position -->
    <div class="card mb-4 quick-actions-floating" id="quickActionsCard" style="position: fixed; bottom: 20px; right: 20px; z-index: 100; width: 320px; transition: all 0.3s ease; border-radius: var(--card-border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" style="cursor: move; border-radius: var(--card-border-radius) var(--card-border-radius) 0 0; background: linear-gradient(135deg, var(--primary-blue), #224abe);">
            <h6 class="m-0 font-weight-bold text-white">Actions rapides</h6>
            <div>
                <button type="button" class="btn btn-sm btn-outline-light" id="pinQuickActions" title="Épingler">
                    <i class="fas fa-thumbtack"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-light ms-2" id="minimizeQuickActions" title="Réduire">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
        </div>
        <div class="card-body p-2" id="quickActionsBody">
            <div class="row g-2">
                <div class="col-6">
                    <a href="{% url 'leave_request' %}" class="btn btn-outline-primary w-100 py-2">
                        <i class="fas fa-plane-departure me-1"></i>
                        Congé
                    </a>
                </div>
                <div class="col-6">
                    <a href="{% url 'submit_expense' %}" class="btn btn-outline-warning w-100 py-2">
                        <i class="fas fa-receipt me-1"></i>
                        Frais
                    </a>
                </div>
                <div class="col-6 mt-2">
                    <a href="{% url 'submit_kilometric_expense' %}" class="btn btn-outline-info w-100 py-2">
                        <i class="fas fa-route me-1"></i>
                        Trajet
                    </a>
                </div>
                <div class="col-6 mt-2">
                    <a href="{% url 'profile' %}" class="btn btn-outline-secondary w-100 py-2">
                        <i class="fas fa-user-cog me-1"></i>
                        Profil
                    </a>
                </div>
            </div>
        </div>
        <div class="card-footer p-1 text-center" id="quickActionsMinimized" style="display: none; background-color: rgba(255,255,255,0.95);">
            <button type="button" class="btn btn-sm btn-primary py-1 px-3" id="expandQuickActions">
                <i class="fas fa-expand-alt me-1"></i> Actions rapides
            </button>
        </div>
    </div>
      <!-- Le script des actions rapides est maintenant dans le bloc extra_scripts -->
    
    <!-- Notifications récentes -->
    {% if notifications %}
    <div class="card stats-card">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Notifications récentes</h6>
            <a href="{% url 'notifications' %}" class="btn btn-sm btn-primary">Tout voir</a>
        </div>
        <div class="card-body">            {% csrf_token %}
            <div class="timeline">
                {% for notification in notifications %}
                <div class="timeline-item" data-notification-id="{{ notification.id }}">
                    <small class="text-muted">{{ notification.created_at|date:"d/m/Y H:i" }}</small>
                    <p class="mb-0 {% if not notification.read %}fw-bold{% endif %}">
                        <i class="fas {{ notification.icon }} text-{{ notification.color }} me-2"></i>
                        {{ notification.title }}
                    </p>
                    {% if notification.content %}
                    <div class="notification-content mt-1 ps-4 text-muted small">
                        {{ notification.content|truncatechars:100 }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        /**
         * SECTION 1: FONCTIONS UTILITAIRES ET INITIALISATION
         * --------------------------------------------------
         */
        
        // Mettre à jour l'horloge en temps réel avec optimisation de performance
        function updateClock() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('fr-FR');
                // Utilisation de requestAnimationFrame pour des performances optimales
                if (document.visibilityState === 'visible') {
                    requestAnimationFrame(() => setTimeout(updateClock, 1000));
                } else {
                    setTimeout(updateClock, 10000); // mise à jour moins fréquente quand l'onglet est inactif
                }
            }
        }
        
        // Animation de valeur numérique avec performance optimisée
        const animateValue = (element, start, end, duration) => {
            if (!element) return;
            
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(progress * (end - start) + start);
                element.textContent = value;
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        };
        
        // Initialiser les tooltips Bootstrap de manière optimisée
        const initTooltips = () => {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        };
        
        /**
         * SECTION 2: GESTION DES ANIMATIONS ET INTERACTIONS
         * ------------------------------------------------
         */
        
        // Animation des badges de notification
        let badgeAnimationActive = true; // Variable pour contrôler l'animation
        const badgeAnimationQueue = new Set(); // Éviter les animations simultanées des mêmes badges
        
        const animateBadges = () => {
            // Vérifier si l'animation est active et si l'onglet est visible
            if (!badgeAnimationActive || document.visibilityState !== 'visible') return;
            
            document.querySelectorAll('.badge-animated').forEach(badge => {
                // Éviter d'animer le même badge plusieurs fois
                if (badgeAnimationQueue.has(badge)) return;
                
                badgeAnimationQueue.add(badge);
                badge.classList.add('pulse');
                
                setTimeout(() => {
                    badge.classList.remove('pulse');
                    badgeAnimationQueue.delete(badge);
                }, 1000);
            });
        };
        
        // Gestion des animations au survol pour les cartes d'action
        const setupActionCardAnimations = () => {
            const actionCards = document.querySelectorAll('.action-card');
            actionCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.willChange = 'transform, box-shadow';
                    this.style.transform = 'translateY(-8px)';
                    this.style.boxShadow = '0 15px 30px rgba(0,0,0,0.1)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                    this.style.boxShadow = '';
                    setTimeout(() => {
                        this.style.willChange = 'auto';
                    }, 300);
                });
            });
        };
        
        // Animation des statistiques avec Intersection Observer
        const setupStatCounters = () => {
            const statValues = document.querySelectorAll('.stat-value[data-value]');
            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1
            };
            
            const statObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const element = entry.target;
                        const value = parseInt(element.dataset.value, 10);
                        animateValue(element, 0, value, 800);
                        statObserver.unobserve(element);
                    }
                });
            }, observerOptions);
            
            statValues.forEach(stat => {
                statObserver.observe(stat);
            });
        };
        
        /**
         * SECTION 3: GESTION DES ACTIONS RAPIDES (PANNEAU FLOTTANT)
         * --------------------------------------------------------
         */
        const setupQuickActions = () => {
            const quickActionsCard = document.getElementById('quickActionsCard');
            const quickActionsBody = document.getElementById('quickActionsBody');
            const quickActionsMinimized = document.getElementById('quickActionsMinimized');
            const minimizeButton = document.getElementById('minimizeQuickActions');
            const expandButton = document.getElementById('expandQuickActions');
            const pinButton = document.getElementById('pinQuickActions');
            
            // État du panneau
            let isPinned = localStorage.getItem('quickActionsPinned') === 'true';
            let isMinimized = localStorage.getItem('quickActionsMinimized') === 'true';
            let cardPosition = JSON.parse(localStorage.getItem('quickActionsPosition')) || { right: '20px', bottom: '20px' };
            
            // Appliquer la position et l'état enregistrés
            if (isPinned) {
                pinButton.classList.add('active');
                pinButton.querySelector('i').classList.add('text-warning');
            }
            
            Object.assign(quickActionsCard.style, {
                right: cardPosition.right,
                bottom: cardPosition.bottom
            });
            
            if (isMinimized) {
                quickActionsBody.style.display = 'none';
                quickActionsMinimized.style.display = 'block';
            }
            
            // Gestionnaires d'événements
            minimizeButton.addEventListener('click', function() {
                quickActionsBody.style.display = 'none';
                quickActionsMinimized.style.display = 'block';
                localStorage.setItem('quickActionsMinimized', 'true');
            });
            
            expandButton.addEventListener('click', function() {
                quickActionsBody.style.display = 'block';
                quickActionsMinimized.style.display = 'none';
                localStorage.setItem('quickActionsMinimized', 'false');
            });
            
            pinButton.addEventListener('click', function() {
                isPinned = !isPinned;
                localStorage.setItem('quickActionsPinned', isPinned);
                
                if (isPinned) {
                    this.classList.add('active');
                    this.querySelector('i').classList.add('text-warning');
                } else {
                    this.classList.remove('active');
                    this.querySelector('i').classList.remove('text-warning');
                }
            });
            
            // Fonctionnalité de déplacement avec Drag & Drop
            const header = quickActionsCard.querySelector('.card-header');
            let isDragging = false;
            let dragOffset = { x: 0, y: 0 };
            
            header.addEventListener('mousedown', function(e) {
                if (isPinned) return; // Ne pas déplacer si épinglé
                
                isDragging = true;
                dragOffset.x = e.clientX - quickActionsCard.offsetLeft;
                dragOffset.y = e.clientY - quickActionsCard.offsetTop;
                
                quickActionsCard.classList.add('dragging');
                
                // Désactiver la sélection de texte pendant le déplacement
                document.body.style.userSelect = 'none';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const x = e.clientX - dragOffset.x;
                const y = e.clientY - dragOffset.y;
                
                // Calculer position en tant que distance depuis les bords de l'écran
                const right = window.innerWidth - (x + quickActionsCard.offsetWidth);
                const bottom = window.innerHeight - (y + quickActionsCard.offsetHeight);
                
                // Limiter aux bords de l'écran
                const clampedRight = Math.max(10, Math.min(window.innerWidth - 100, right));
                const clampedBottom = Math.max(10, Math.min(window.innerHeight - 100, bottom));
                
                quickActionsCard.style.right = `${clampedRight}px`;
                quickActionsCard.style.bottom = `${clampedBottom}px`;
            });
            
            document.addEventListener('mouseup', function() {
                if (!isDragging) return;
                
                isDragging = false;
                quickActionsCard.classList.remove('dragging');
                document.body.style.userSelect = '';
                
                // Sauvegarder la position
                cardPosition = {
                    right: quickActionsCard.style.right,
                    bottom: quickActionsCard.style.bottom
                };
                localStorage.setItem('quickActionsPosition', JSON.stringify(cardPosition));
            });
        };
        
        /**
         * SECTION 4: GESTION DES NOTIFICATIONS
         * -----------------------------------
         */
        const setupNotifications = () => {
            // Gestion de l'affichage des notifications et marquage comme lues
            const notificationItems = document.querySelectorAll('.timeline-item');
            
            notificationItems.forEach(item => {
                item.addEventListener('click', function() {
                    const notificationId = this.dataset.notificationId;                    if (notificationId) {
                        // Marquer comme lu visuellement
                        const notifText = this.querySelector('p');
                        if (notifText && notifText.classList.contains('fw-bold')) {
                            notifText.classList.remove('fw-bold');
                        }
                          
                        // Envoyer requête pour marquer comme lu côté serveur (AJAX)
                        fetch(`/notifications/mark-read/${notificationId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erreur réseau');
                            }
                            return response.json();
                        })
                        .catch(error => {
                            console.error('Erreur lors du marquage de la notification:', error);
                            // Remettre en gras si l'opération échoue
                            if (notifText) notifText.classList.add('fw-bold');
                        });
                    }
                });
            });
        };
        
        /**
         * SECTION 5: INITIALISATION ET DÉMARRAGE
         * -------------------------------------
         */
        // Démarrer l'horloge
        updateClock();
        
        // Configurer les animations et interactions
        setupActionCardAnimations();
        setupStatCounters();
        setupQuickActions();
        setupNotifications(); 
        
        // Initialiser les tooltips
        if ('requestIdleCallback' in window) {
            requestIdleCallback(initTooltips);
        } else {
            setTimeout(initTooltips, 200);
        }
        
        // Configuration de l'animation des badges
        animateBadges(); // Animation initiale
        let badgeInterval = setInterval(animateBadges, 5000);
        
        // Gestion de la visibilité de la page pour économiser les ressources
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                clearInterval(badgeInterval);
                badgeAnimationActive = false;
            } else {
                badgeAnimationActive = true;
                clearInterval(badgeInterval);
                badgeInterval = setInterval(animateBadges, 5000);
                animateBadges(); // Anime immédiatement quand la page redevient visible
            }
        });
    });
</script>
{% endblock %}