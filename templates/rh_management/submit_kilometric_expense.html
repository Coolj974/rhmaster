{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-car me-2"></i>Déclaration de frais kilométriques</h4>
        </div>
        <div class="card-body p-4">
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>
                Sélectionnez votre itinéraire sur la carte ou saisissez les adresses directement.
            </div>
            
            <form id="kilometric-expense-form" method="post" class="needs-validation" novalidate action="{% url 'submit_kilometric_expense' %}">
                {% csrf_token %}
                
                <!-- Champs obligatoires -->
                <input type="hidden" name="departure_lat" id="departure_lat" required>
                <input type="hidden" name="departure_lng" id="departure_lng" required>
                <input type="hidden" name="arrival_lat" id="arrival_lat" required>
                <input type="hidden" name="arrival_lng" id="arrival_lng" required>
                <input type="hidden" name="distance" id="distance" required>
                <input type="hidden" name="amount" id="amount" required>

                <div class="row">
                    <!-- Panneau d'information du véhicule -->
                    <div class="col-lg-5 mb-4">
                        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-car-side me-2"></i>Information véhicule</h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="id_date" class="form-label">Date <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                    {{ form.date }}
                                </div>
                                {% if form.date.errors %}
                                <div class="text-danger small mt-1">{{ form.date.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_vehicle_type" class="form-label">Type de véhicule <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-car"></i></span>
                                    {{ form.vehicle_type }}
                                </div>
                                {% if form.vehicle_type.errors %}
                                <div class="text-danger small mt-1">{{ form.vehicle_type.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_fiscal_power" class="form-label">Puissance fiscale <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tachometer-alt"></i></span>
                                    {{ form.fiscal_power }}
                                </div>
                                {% if form.fiscal_power.errors %}
                                <div class="text-danger small mt-1">{{ form.fiscal_power.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_project" class="form-label">Projet <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-project-diagram"></i></span>
                                    {{ form.project }}
                                </div>
                                {% if form.project.errors %}
                                <div class="text-danger small mt-1">{{ form.project.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <h5 class="mt-4 mb-3 border-bottom pb-2"><i class="fas fa-calculator me-2"></i>Remboursement</h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="distance_field" class="form-label">Distance (km)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-road"></i></span>
                                    <input type="text" id="distance_field" name="distance" class="form-control" readonly required>
                                </div>
                                <div class="form-text">Calculée selon l'itinéraire</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="reimbursement" class="form-label">Montant (€)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                                    <input type="text" id="reimbursement" name="reimbursement" class="form-control text-success" readonly required>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="aller_retour">
                                    <label class="form-check-label" for="aller_retour">
                                        <i class="fas fa-exchange-alt me-2"></i>Aller-retour
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card bg-light mt-3">
                            <div class="card-body">
                                <h6 class="mb-2"><i class="fas fa-bell me-2"></i>Notifications</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notify_manager" checked>
                                    <label class="form-check-label" for="notify_manager">
                                        <i class="fas fa-user-tie me-1"></i> Informer mon responsable
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notify_hr" checked>
                                    <label class="form-check-label" for="notify_hr">
                                        <i class="fas fa-users-cog me-1"></i> Informer les ressources humaines
                                    </label>
                                </div>
                                <input type="hidden" name="notification_emails" id="notification_emails">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carte et itinéraire -->
                    <div class="col-lg-7">
                        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-route me-2"></i>Itinéraire</h5>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="departure" class="form-label">Départ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt text-danger"></i></span>
                                    <input type="text" id="departure" name="departure" class="form-control" placeholder="Adresse de départ" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="arrival" class="form-label">Arrivée <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-flag-checkered text-success"></i></span>
                                    <input type="text" id="arrival" name="arrival" class="form-control" placeholder="Adresse d'arrivée" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="fas fa-map me-2"></i>Carte interactive</span>
                                <button type="button" id="clearMap" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-trash-alt me-1"></i>Effacer
                                </button>
                            </div>
                            <div id="map" style="height: 400px;" class="border rounded"></div>
                            <div class="form-text" id="map-instructions">
                                Cliquez d'abord sur votre point de départ, puis sur votre destination.
                            </div>
                        </div>
                        
                        <input type="hidden" id="departure_lat" name="departure_lat" required>
                        <input type="hidden" id="departure_lng" name="departure_lng" required>
                        <input type="hidden" id="arrival_lat" name="arrival_lat" required>
                        <input type="hidden" id="arrival_lng" name="arrival_lng" required>
                        <input type="hidden" name="distance" id="distance" required>
                        <input type="hidden" name="amount" id="amount" required>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary px-4 py-2" id="submitBtn">
                                <i class="fas fa-paper-plane me-2"></i> Soumettre ma demande
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>   
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Éléments du formulaire
        const form = document.getElementById("kilometric-expense-form");
        const allerRetourCheckbox = document.getElementById("aller_retour");
        const distanceField = document.getElementById("distance_field");
        const reimbursementField = document.getElementById("reimbursement");
        const vehicleTypeField = document.getElementById("id_vehicle_type");
        const fiscalPowerField = document.getElementById("id_fiscal_power");
        const clearMapBtn = document.getElementById("clearMap");
        const mapInstructions = document.getElementById("map-instructions");
        
        // Taux de remboursement simplifiés
        const reimbursementRates = {
            'car': {
                3: 0.45,
                4: 0.5,
                5: 0.55,
                6: 0.6,
                7: 0.65,
                8: 0.7
            },
            'electric_car': {
                3: 0.55,
                4: 0.6,
                5: 0.65,
                6: 0.7,
                7: 0.75,
                8: 0.8
            },
            'motorbike': {
                3: 0.35,
                4: 0.4,
                5: 0.45,
                6: 0.5,
                7: 0.55,
                8: 0.6
            },
            'bicycle': {
                1: 0.1,
                2: 0.12,
                3: 0.15
            }
        };

        // Stocker la distance initiale
        let distanceInitiale = 0;

        // Gérer l'aller-retour
        allerRetourCheckbox.addEventListener("change", function() {
            if (distanceInitiale === 0) {
                distanceInitiale = parseFloat(distanceField.value) || 0;
            }
            
            if (this.checked) {
                distanceField.value = (distanceInitiale * 2).toFixed(2);
                mapInstructions.innerHTML = "Distance doublée pour l'aller-retour";
            } else {
                distanceField.value = distanceInitiale.toFixed(2);
                mapInstructions.innerHTML = "Distance simple pour l'aller simple";
            }
            updateReimbursement();
        });

        // Mise à jour quand la distance change
        distanceField.addEventListener("input", function() {
            if (!allerRetourCheckbox.checked) {
                distanceInitiale = parseFloat(this.value) || 0;
            }
            updateReimbursement();
        });

        // Mise à jour quand le type de véhicule change
        vehicleTypeField.addEventListener("change", updateReimbursement);
        fiscalPowerField.addEventListener("change", updateReimbursement);

        // Calculer le remboursement
        function updateReimbursement() {
            const distance = parseFloat(distanceField.value) || 0;
            const vehicleType = vehicleTypeField.value;
            const fiscalPower = parseInt(fiscalPowerField.value);

            if (vehicleType && fiscalPower && reimbursementRates[vehicleType] && reimbursementRates[vehicleType][fiscalPower]) {
                const rate = reimbursementRates[vehicleType][fiscalPower];
                const reimbursement = distance * rate;
                reimbursementField.value = reimbursement.toFixed(2);
            } else {
                reimbursementField.value = "0.00";
            }
        }

        // Configuration de la carte
        let map = L.map('map').setView([-21.1151, 55.5364], 10); // Centré sur l'île de la Réunion

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let departureMarker, arrivalMarker;
        let routeLayer = null;
        const openRouteServiceApiKey = "5b3ce3597851110001cf6248b85e99a3c95448b8a83d306fd7b84056";

        // Géocodage des adresses
        document.getElementById('departure').addEventListener('change', function() {
            if(this.value && !departureMarker) {
                geocodeAddress(this.value, 'departure');
            }
        });
        
        document.getElementById('arrival').addEventListener('change', function() {
            if(this.value && !arrivalMarker && departureMarker) {
                geocodeAddress(this.value, 'arrival');
            }
        });
        
        // Recherche d'adresse
        function geocodeAddress(address, type) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if(data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        updateMarker(lat, lng, type);
                    } else {
                        alert("Adresse non trouvée");
                    }
                })
                .catch(error => console.error("Erreur:", error));
        }

        // Mise à jour des marqueurs
        function updateMarker(lat, lng, type) {
            if (type === 'departure') {
                if (departureMarker) map.removeLayer(departureMarker);
                departureMarker = L.marker([lat, lng]).addTo(map).bindPopup("Départ").openPopup();
                document.getElementById("departure_lat").value = lat;
                document.getElementById("departure_lng").value = lng;
                reverseGeocode(lat, lng, "departure");
                mapInstructions.innerHTML = "Maintenant, cliquez sur votre point d'arrivée";
            } else {
                if (arrivalMarker) map.removeLayer(arrivalMarker);
                arrivalMarker = L.marker([lat, lng]).addTo(map).bindPopup("Arrivée").openPopup();
                document.getElementById("arrival_lat").value = lat;
                document.getElementById("arrival_lng").value = lng;
                reverseGeocode(lat, lng, "arrival");
                mapInstructions.innerHTML = "Itinéraire calculé!";
            }
            calculateRoute();
        }

        // Conversion coordonnées -> adresse
        function reverseGeocode(lat, lng, type) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    let address = data.display_name;
                    if (type === "departure") {
                        document.getElementById("departure").value = address;
                    } else {
                        document.getElementById("arrival").value = address;
                    }
                })
                .catch(error => console.error("Erreur:", error));
        }

        // Calcul de l'itinéraire
        function calculateRoute() {
            if (!departureMarker || !arrivalMarker) return;

            const lat1 = departureMarker.getLatLng().lat;
            const lng1 = departureMarker.getLatLng().lng;
            const lat2 = arrivalMarker.getLatLng().lat;
            const lng2 = arrivalMarker.getLatLng().lng;

            // Utilisation de l'API OSRM pour plus de fiabilité
            const url = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=full`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        // Récupération de la distance en kilomètres
                        const distance = data.routes[0].distance / 1000;
                        
                        // Mise à jour de l'affichage de la distance
                        document.getElementById('distance_field').value = distance.toFixed(2);
                        document.getElementById('distance').value = distance.toFixed(2);

                        // Tracé de l'itinéraire
                        if (routeLayer) {
                            map.removeLayer(routeLayer);
                        }

                        // Décodage de la géométrie de l'itinéraire
                        const coordinates = decodePolyline(data.routes[0].geometry);
                        routeLayer = L.polyline(coordinates, {color: 'blue'}).addTo(map);
                        map.fitBounds(routeLayer.getBounds(), {padding: [30, 30]});

                        // Mise à jour du montant
                        updateReimbursement();
                        
                        // Activation du bouton de soumission
                        document.getElementById('submitBtn').disabled = false;
                        updateDistance(distance);
                        enableSubmitButton();
                    } else {
                        alert("Impossible de calculer l'itinéraire entre ces deux points.");
                    }
                })
                .catch(error => {
                    console.error("Erreur:", error);
                    // Calcul de la distance à vol d'oiseau en fallback
                    const distance = calculateDirectDistance(lat1, lng1, lat2, lng2);
                    document.getElementById('distance_field').value = distance.toFixed(2);
                    document.getElementById('distance').value = distance.toFixed(2);
                    updateReimbursement();
                });
        }

        // Fonction pour calculer la distance à vol d'oiseau (en cas d'échec de l'API)
        function calculateDirectDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function toRad(degrees) {
            return degrees * Math.PI / 180;
        }

        // Fonction pour décoder la géométrie de l'itinéraire
        function decodePolyline(str, precision = 5) {
            let index = 0,
                lat = 0,
                lng = 0,
                coordinates = [],
                shift = 0,
                result = 0,
                byte = null,
                latitude_change,
                longitude_change,
                factor = Math.pow(10, precision);

            while (index < str.length) {
                byte = null;
                shift = 0;
                result = 0;

                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));
                shift = result = 0;

                do {
                    byte = str.charCodeAt(index++) - 63;
                    result |= (byte & 0x1f) << shift;
                    shift += 5;
                } while (byte >= 0x20);

                longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

                lat += latitude_change;
                lng += longitude_change;

                coordinates.push([lat / factor, lng / factor]);
            }

            return coordinates;
        }

        // Réinitialiser la carte
        clearMapBtn.addEventListener('click', function() {
            if (departureMarker) {
                map.removeLayer(departureMarker);
                departureMarker = null;
                document.getElementById("departure").value = "";
                document.getElementById("departure_lat").value = "";
                document.getElementById("departure_lng").value = "";
            }
            
            if (arrivalMarker) {
                map.removeLayer(arrivalMarker);
                arrivalMarker = null;
                document.getElementById("arrival").value = "";
                document.getElementById("arrival_lat").value = "";
                document.getElementById("arrival_lng").value = "";
            }
            
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            distanceField.value = "0.00";
            reimbursementField.value = "0.00";
            distanceInitiale = 0;
            
            mapInstructions.innerHTML = "Cliquez d'abord sur votre point de départ, puis sur votre destination.";
        });

        // Clic sur la carte
        map.on('click', function(e) {
            if (!departureMarker) {
                updateMarker(e.latlng.lat, e.latlng.lng, 'departure');
            } else if (!arrivalMarker) {
                updateMarker(e.latlng.lat, e.latlng.lng, 'arrival');
            }
        });

        // Validation du formulaire
        form.addEventListener("submit", function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                const requiredFields = form.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    if (!field.value) {
                        field.classList.add('is-invalid');
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
            } else {
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Traitement...';
                submitBtn.disabled = true;
            }
            form.classList.add("was-validated");
        });
        
        // Gérer les notifications par email
        const notifyManagerCheckbox = document.getElementById('notify_manager');
        const notifyHRCheckbox = document.getElementById('notify_hr');
        const notificationEmailsInput = document.getElementById('notification_emails');
        
        function updateNotificationEmails() {
            let emails = [];
            if (notifyManagerCheckbox.checked) {
                emails.push('manager@example.com');
            }
            if (notifyHRCheckbox.checked) {
                emails.push('bcc:hr@example.com');
            }
            notificationEmailsInput.value = emails.join(',');
        }
        
        notifyManagerCheckbox.addEventListener('change', updateNotificationEmails);
        notifyHRCheckbox.addEventListener('change', updateNotificationEmails);
        
        // Initialiser les notifications
        updateNotificationEmails();

        // Nouvelle fonction pour vérifier la validité du formulaire
        function enableSubmitButton() {
            const departure = document.getElementById('departure').value;
            const arrival = document.getElementById('arrival').value;
            const distance = document.getElementById('distance').value;
            const date = document.getElementById('id_date').value;
            const vehicleType = document.getElementById('id_vehicle_type').value;
            const fiscalPower = document.getElementById('id_fiscal_power').value;
            const project = document.getElementById('id_project').value;

            const isValid = departure && arrival && distance && date && vehicleType && fiscalPower && project;
            document.getElementById('submitBtn').disabled = !isValid;
        }

        // Ajouter les écouteurs d'événements pour tous les champs requis
        const requiredFields = document.querySelectorAll('input[required], select[required]');
        requiredFields.forEach(field => {
            field.addEventListener('change', enableSubmitButton);
            field.addEventListener('input', enableSubmitButton);
        });

        // Supprimer le disabled initial du bouton
        document.getElementById('submitBtn').removeAttribute('disabled');
    });

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('kilometric-expense-form');
        const submitBtn = document.getElementById('submitBtn');

        // Fonction pour vérifier si le formulaire est valide
        function checkFormValidity() {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                }
            });
            
            submitBtn.disabled = !isValid;
        }

        // Vérifier à chaque modification du formulaire
        form.addEventListener('change', checkFormValidity);

        // Validation avant soumission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Vérifier les coordonnées
            if (!document.getElementById('departure_lat').value || 
                !document.getElementById('arrival_lat').value) {
                alert('Veuillez sélectionner un point de départ et d\'arrivée sur la carte');
                return;
            }

            // Vérifier la distance
            if (!document.getElementById('distance').value) {
                alert('La distance n\'a pas pu être calculée');
                return;
            }

            // Si tout est OK, soumettre le formulaire
            this.submit();
        });

        // Mettre à jour les champs cachés lors du calcul de l'itinéraire
        function updateFormFields(route) {
            document.getElementById('distance').value = route.distance.toFixed(2);
            document.getElementById('amount').value = calculateAmount(route.distance);
            checkFormValidity();
        }

        // Calcul du montant en fonction de la distance et du type de véhicule
        function calculateAmount(distance) {
            const vehicleType = document.getElementById('id_vehicle_type').value;
            const fiscalPower = document.getElementById('id_fiscal_power').value;
            // ...existing code pour le calcul du montant...
        }
    });

    // Mise à jour de la distance
    function updateDistance(distance) {
        // Mettre à jour l'affichage ET le champ caché
        document.getElementById('distance_field').value = distance.toFixed(2);
        updateReimbursement();
    }
</script>
{% endblock %}