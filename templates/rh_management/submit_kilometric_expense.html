{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-car me-2"></i>Déclaration de frais kilométriques</h4>
        </div>
        <div class="card-body p-4">
            <div class="alert alert-info mb-4">
                <i class="fas fa-info-circle me-2"></i>
                Sélectionnez votre itinéraire sur la carte ou saisissez les adresses directement.
            </div>
            
            <form id="kilometric-expense-form" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <div class="row">
                    <!-- Panneau d'information du véhicule -->
                    <div class="col-lg-5 mb-4">
                        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-car-side me-2"></i>Information véhicule</h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="id_date" class="form-label">Date <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                    {{ form.date }}
                                </div>
                                {% if form.date.errors %}
                                <div class="text-danger small mt-1">{{ form.date.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_vehicle_type" class="form-label">Type de véhicule <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-car"></i></span>
                                    {{ form.vehicle_type }}
                                </div>
                                {% if form.vehicle_type.errors %}
                                <div class="text-danger small mt-1">{{ form.vehicle_type.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_fiscal_power" class="form-label">Puissance fiscale <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tachometer-alt"></i></span>
                                    {{ form.fiscal_power }}
                                </div>
                                {% if form.fiscal_power.errors %}
                                <div class="text-danger small mt-1">{{ form.fiscal_power.errors }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_project" class="form-label">Projet <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-project-diagram"></i></span>
                                    {{ form.project }}
                                </div>
                                {% if form.project.errors %}
                                <div class="text-danger small mt-1">{{ form.project.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <h5 class="mt-4 mb-3 border-bottom pb-2"><i class="fas fa-calculator me-2"></i>Remboursement</h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="distance" class="form-label">Distance (km)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-road"></i></span>
                                    <input type="text" id="distance" name="distance" class="form-control" readonly required>
                                </div>
                                <div class="form-text">Calculée selon l'itinéraire</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="reimbursement" class="form-label">Montant (€)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                                    <input type="text" id="reimbursement" name="reimbursement" class="form-control text-success" readonly required>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="aller_retour">
                                    <label class="form-check-label" for="aller_retour">
                                        <i class="fas fa-exchange-alt me-2"></i>Aller-retour
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card bg-light mt-3">
                            <div class="card-body">
                                <h6 class="mb-2"><i class="fas fa-bell me-2"></i>Notifications</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notify_manager" checked>
                                    <label class="form-check-label" for="notify_manager">
                                        <i class="fas fa-user-tie me-1"></i> Informer mon responsable
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="notify_hr" checked>
                                    <label class="form-check-label" for="notify_hr">
                                        <i class="fas fa-users-cog me-1"></i> Informer les ressources humaines
                                    </label>
                                </div>
                                <input type="hidden" name="notification_emails" id="notification_emails">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Carte et itinéraire -->
                    <div class="col-lg-7">
                        <h5 class="mb-3 border-bottom pb-2"><i class="fas fa-route me-2"></i>Itinéraire</h5>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="departure" class="form-label">Départ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt text-danger"></i></span>
                                    <input type="text" id="departure" name="departure" class="form-control" placeholder="Adresse de départ" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="arrival" class="form-label">Arrivée <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-flag-checkered text-success"></i></span>
                                    <input type="text" id="arrival" name="arrival" class="form-control" placeholder="Adresse d'arrivée" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="fas fa-map me-2"></i>Carte interactive</span>
                                <button type="button" id="clearMap" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-trash-alt me-1"></i>Effacer
                                </button>
                            </div>
                            <div id="map" style="height: 400px;" class="border rounded"></div>
                            <div class="form-text" id="map-instructions">
                                Cliquez d'abord sur votre point de départ, puis sur votre destination.
                            </div>
                        </div>
                        
                        <input type="hidden" id="departure_lat" name="departure_lat" required>
                        <input type="hidden" id="departure_lng" name="departure_lng" required>
                        <input type="hidden" id="arrival_lat" name="arrival_lat" required>
                        <input type="hidden" id="arrival_lng" name="arrival_lng" required>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary px-4 py-2">
                                <i class="fas fa-paper-plane me-2"></i> Soumettre ma demande
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Leaflet.js -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>   
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Éléments du formulaire
        const form = document.getElementById("kilometric-expense-form");
        const allerRetourCheckbox = document.getElementById("aller_retour");
        const distanceField = document.getElementById("distance");
        const reimbursementField = document.getElementById("reimbursement");
        const vehicleTypeField = document.getElementById("id_vehicle_type");
        const fiscalPowerField = document.getElementById("id_fiscal_power");
        const clearMapBtn = document.getElementById("clearMap");
        const mapInstructions = document.getElementById("map-instructions");
        
        // Taux de remboursement simplifiés
        const reimbursementRates = {
            'car': {
                3: 0.45,
                4: 0.5,
                5: 0.55,
                6: 0.6,
                7: 0.65,
                8: 0.7
            },
            'electric_car': {
                3: 0.55,
                4: 0.6,
                5: 0.65,
                6: 0.7,
                7: 0.75,
                8: 0.8
            },
            'motorbike': {
                3: 0.35,
                4: 0.4,
                5: 0.45,
                6: 0.5,
                7: 0.55,
                8: 0.6
            },
            'bicycle': {
                1: 0.1,
                2: 0.12,
                3: 0.15
            }
        };

        // Stocker la distance initiale
        let distanceInitiale = 0;

        // Gérer l'aller-retour
        allerRetourCheckbox.addEventListener("change", function() {
            if (distanceInitiale === 0) {
                distanceInitiale = parseFloat(distanceField.value) || 0;
            }
            
            if (this.checked) {
                distanceField.value = (distanceInitiale * 2).toFixed(2);
                mapInstructions.innerHTML = "Distance doublée pour l'aller-retour";
            } else {
                distanceField.value = distanceInitiale.toFixed(2);
                mapInstructions.innerHTML = "Distance simple pour l'aller simple";
            }
            updateReimbursement();
        });

        // Mise à jour quand la distance change
        distanceField.addEventListener("input", function() {
            if (!allerRetourCheckbox.checked) {
                distanceInitiale = parseFloat(this.value) || 0;
            }
            updateReimbursement();
        });

        // Mise à jour quand le type de véhicule change
        vehicleTypeField.addEventListener("change", updateReimbursement);
        fiscalPowerField.addEventListener("change", updateReimbursement);

        // Calculer le remboursement
        function updateReimbursement() {
            const distance = parseFloat(distanceField.value) || 0;
            const vehicleType = vehicleTypeField.value;
            const fiscalPower = parseInt(fiscalPowerField.value);

            if (vehicleType && fiscalPower && reimbursementRates[vehicleType] && reimbursementRates[vehicleType][fiscalPower]) {
                const rate = reimbursementRates[vehicleType][fiscalPower];
                const reimbursement = distance * rate;
                reimbursementField.value = reimbursement.toFixed(2);
            } else {
                reimbursementField.value = "0.00";
            }
        }

        // Configuration de la carte
        let map = L.map('map').setView([-21.1151, 55.5364], 10); // Centré sur l'île de la Réunion

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let departureMarker, arrivalMarker;
        let routeLayer = null;
        const openRouteServiceApiKey = "5b3ce3597851110001cf6248b85e99a3c95448b8a83d306fd7b84056";

        // Géocodage des adresses
        document.getElementById('departure').addEventListener('change', function() {
            if(this.value && !departureMarker) {
                geocodeAddress(this.value, 'departure');
            }
        });
        
        document.getElementById('arrival').addEventListener('change', function() {
            if(this.value && !arrivalMarker && departureMarker) {
                geocodeAddress(this.value, 'arrival');
            }
        });
        
        // Recherche d'adresse
        function geocodeAddress(address, type) {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if(data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        updateMarker(lat, lng, type);
                    } else {
                        alert("Adresse non trouvée");
                    }
                })
                .catch(error => console.error("Erreur:", error));
        }

        // Mise à jour des marqueurs
        function updateMarker(lat, lng, type) {
            if (type === 'departure') {
                if (departureMarker) map.removeLayer(departureMarker);
                departureMarker = L.marker([lat, lng]).addTo(map).bindPopup("Départ").openPopup();
                document.getElementById("departure_lat").value = lat;
                document.getElementById("departure_lng").value = lng;
                reverseGeocode(lat, lng, "departure");
                mapInstructions.innerHTML = "Maintenant, cliquez sur votre point d'arrivée";
            } else {
                if (arrivalMarker) map.removeLayer(arrivalMarker);
                arrivalMarker = L.marker([lat, lng]).addTo(map).bindPopup("Arrivée").openPopup();
                document.getElementById("arrival_lat").value = lat;
                document.getElementById("arrival_lng").value = lng;
                reverseGeocode(lat, lng, "arrival");
                mapInstructions.innerHTML = "Itinéraire calculé!";
            }
            calculateRoute();
        }

        // Conversion coordonnées -> adresse
        function reverseGeocode(lat, lng, type) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    let address = data.display_name;
                    if (type === "departure") {
                        document.getElementById("departure").value = address;
                    } else {
                        document.getElementById("arrival").value = address;
                    }
                })
                .catch(error => console.error("Erreur:", error));
        }

        // Calcul de l'itinéraire
        function calculateRoute() {
            if (departureMarker && arrivalMarker) {
                let lat1 = departureMarker.getLatLng().lat;
                let lng1 = departureMarker.getLatLng().lng;
                let lat2 = arrivalMarker.getLatLng().lat;
                let lng2 = arrivalMarker.getLatLng().lng;

                let url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${openRouteServiceApiKey}&start=${lng1},${lat1}&end=${lng2},${lat2}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.features && data.features.length > 0) {
                            let route = data.features[0];
                            if (route.properties && route.properties.segments && route.properties.segments.length > 0) {
                                let distance = route.properties.segments[0].distance / 1000; // Convertir en km
                                distanceField.value = distance.toFixed(2);
                                distanceInitiale = distance;

                                if (routeLayer) {
                                    map.removeLayer(routeLayer);
                                }

                                let routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                                routeLayer = L.polyline(routeCoordinates, {color: 'blue'}).addTo(map);
                                map.fitBounds(routeLayer.getBounds());

                                updateReimbursement();
                            } else {
                                alert("Aucune route trouvée");
                            }
                        } else {
                            alert("Aucune route trouvée");
                        }
                    })
                    .catch(error => {
                        console.error("Erreur:", error);
                        alert("Erreur lors du calcul de l'itinéraire");
                    });
            }
        }

        // Réinitialiser la carte
        clearMapBtn.addEventListener('click', function() {
            if (departureMarker) {
                map.removeLayer(departureMarker);
                departureMarker = null;
                document.getElementById("departure").value = "";
                document.getElementById("departure_lat").value = "";
                document.getElementById("departure_lng").value = "";
            }
            
            if (arrivalMarker) {
                map.removeLayer(arrivalMarker);
                arrivalMarker = null;
                document.getElementById("arrival").value = "";
                document.getElementById("arrival_lat").value = "";
                document.getElementById("arrival_lng").value = "";
            }
            
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            distanceField.value = "0.00";
            reimbursementField.value = "0.00";
            distanceInitiale = 0;
            
            mapInstructions.innerHTML = "Cliquez d'abord sur votre point de départ, puis sur votre destination.";
        });

        // Clic sur la carte
        map.on('click', function(e) {
            if (!departureMarker) {
                updateMarker(e.latlng.lat, e.latlng.lng, 'departure');
            } else if (!arrivalMarker) {
                updateMarker(e.latlng.lat, e.latlng.lng, 'arrival');
            }
        });

        // Validation du formulaire
        form.addEventListener("submit", function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                const requiredFields = form.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    if (!field.value) {
                        field.classList.add('is-invalid');
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
            } else {
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Traitement...';
                submitBtn.disabled = true;
            }
            form.classList.add("was-validated");
        });
        
        // Gérer les notifications par email
        const notifyManagerCheckbox = document.getElementById('notify_manager');
        const notifyHRCheckbox = document.getElementById('notify_hr');
        const notificationEmailsInput = document.getElementById('notification_emails');
        
        function updateNotificationEmails() {
            let emails = [];
            if (notifyManagerCheckbox.checked) {
                emails.push('manager@example.com');
            }
            if (notifyHRCheckbox.checked) {
                emails.push('bcc:hr@example.com');
            }
            notificationEmailsInput.value = emails.join(',');
        }
        
        notifyManagerCheckbox.addEventListener('change', updateNotificationEmails);
        notifyHRCheckbox.addEventListener('change', updateNotificationEmails);
        
        // Initialiser les notifications
        updateNotificationEmails();
    });
</script>
{% endblock %}