{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-receipt me-2"></i>Note de frais</h1>
        <div>
            <a href="{% url 'dashboard' %}" class="btn btn-sm btn-secondary shadow-sm">
                <i class="fas fa-arrow-left fa-sm me-1"></i> Retour au tableau de bord
            </a>
        </div>
    </div>
    
    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                    <i class="{% if message.tags == 'success' %}fas fa-check-circle{% elif message.tags == 'error' %}fas fa-exclamation-circle{% else %}fas fa-info-circle{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    <div class="row">
        <!-- Formulaire de soumission de note de frais -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-plus-circle me-2"></i>Nouvelle note de frais</h6>
                </div>
                <div class="card-body">
                    <form method="post" action="{% url 'submit_expense' %}" enctype="multipart/form-data" id="expenseForm">
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="expense_date" class="form-label">Date de la dépense <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="expense_date" name="expense_date" required max="{{ today|date:'Y-m-d' }}">
                                </div>
                                <div class="form-text">Date à laquelle la dépense a été effectuée</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="amount" class="form-label">Montant <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                                    <input type="number" step="0.01" min="0.01" class="form-control" id="amount" name="amount" required placeholder="0.00">
                                    <span class="input-group-text">€</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category" class="form-label">Catégorie <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">-- Sélectionner une catégorie --</option>
                                    <option value="transport">Transport (hors kilométrique)</option>
                                    <option value="meal">Repas</option>
                                    <option value="accommodation">Hébergement</option>
                                    <option value="supplies">Fournitures</option>
                                    <option value="communication">Communication</option>
                                    <option value="representation">Frais de représentation</option>
                                    <option value="other">Autre</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-align-left"></i></span>
                                <textarea class="form-control" id="description" name="description" rows="3" required placeholder="Détails de la dépense..."></textarea>
                            </div>
                            <div class="form-text">Précisez le contexte et le but de cette dépense</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="receipt" class="form-label">Justificatif <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-file-invoice"></i></span>
                                <input type="file" class="form-control" id="receipt" name="receipt" accept=".pdf,.jpg,.jpeg,.png" required>
                            </div>
                            <div class="form-text">Formats acceptés: PDF, JPEG, PNG. Taille maximale: 5 Mo.</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="vat_receipt" name="vat_receipt">
                                <label class="form-check-label" for="vat_receipt">
                                    Cette facture contient de la TVA récupérable
                                </label>
                            </div>
                        </div>
                        
                        <div id="vat_details" class="mb-3 card bg-light p-3 d-none">
                            <h6 class="card-title">Détails de TVA</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="vat_amount" class="form-label">Montant de TVA</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-euro-sign"></i></span>
                                        <input type="number" step="0.01" min="0" class="form-control" id="vat_amount" name="vat_amount" placeholder="0.00">
                                        <span class="input-group-text">€</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="vat_rate" class="form-label">Taux de TVA</label>
                                    <select class="form-select" id="vat_rate" name="vat_rate">
                                        <option value="">-- Sélectionner --</option>
                                        <option value="20">20%</option>
                                        <option value="10">10%</option>
                                        <option value="5.5">5.5%</option>
                                        <option value="2.1">2.1%</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notify_manager" name="notify_manager" checked>
                                <label class="form-check-label" for="notify_manager">Notifier mon responsable</label>
                            </div>
                            
                            <div>
                                <button type="reset" class="btn btn-light me-2">
                                    <i class="fas fa-undo me-1"></i> Réinitialiser
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i> Soumettre ma note de frais
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Aide et informations -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold"><i class="fas fa-info-circle me-2"></i>Informations</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h5 class="h6 font-weight-bold">Politique de remboursement</h5>
                        <ul class="small">
                            <li>Les notes de frais sont traitées sous 7 jours.</li>
                            <li>Le remboursement est effectué avec la paie du mois suivant.</li>
                            <li>Un justificatif original est requis pour toute dépense.</li>
                            <li>Les frais kilométriques doivent être soumis séparément.</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <h5 class="h6 font-weight-bold">Plafonds par catégorie</h5>
                        <table class="table table-sm table-striped small">
                            <tr>
                                <td>Repas</td>
                                <td class="text-right">25€ / repas</td>
                            </tr>
                            <tr>
                                <td>Hôtel (Province)</td>
                                <td class="text-right">90€ / nuit</td>
                            </tr>
                            <tr>
                                <td>Hôtel (Paris)</td>
                                <td class="text-right">120€ / nuit</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div class="alert alert-warning mb-0 small">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Les notes de frais soumises sans justificatif valide seront automatiquement refusées.
                    </div>
                </div>
            </div>
            
            <!-- Dernières notes de frais -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-history me-2"></i>Vos dernières notes de frais</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for expense in recent_expenses %}
                        <div class="list-group-item py-3">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 text-truncate">{{ expense.description|truncatechars:25 }}</h6>
                                <span class="badge {% if expense.status == 'approved' %}bg-success{% elif expense.status == 'rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                                    {{ expense.get_status_display }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center small">
                                <span class="text-muted">
                                    <i class="fas fa-calendar-day me-1"></i>{{ expense.expense_date|date:"d/m/Y" }}
                                </span>
                                <span class="fw-bold">{{ expense.amount }} €</span>
                            </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item py-4 text-center">
                            <i class="fas fa-receipt text-muted fa-2x mb-3"></i>
                            <p class="mb-0">Vous n'avez pas encore soumis de note de frais</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if recent_expenses %}
                    <div class="card-footer text-center">
                        <a href="{% url 'my_expenses_view' %}" class="btn btn-sm btn-outline-primary">
                            Voir toutes mes notes de frais
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Afficher ou masquer les détails de TVA
    const vatCheckbox = document.getElementById('vat_receipt');
    const vatDetails = document.getElementById('vat_details');
    
    vatCheckbox.addEventListener('change', function() {
        if (this.checked) {
            vatDetails.classList.remove('d-none');
        } else {
            vatDetails.classList.add('d-none');
        }
    });
    
    // Validation du formulaire
    const expenseForm = document.getElementById('expenseForm');
    const receiptInput = document.getElementById('receipt');
    
    expenseForm.addEventListener('submit', function(e) {
        // Vérifier la taille du fichier
        if (receiptInput.files.length > 0) {
            const fileSize = receiptInput.files[0].size;
            const maxSize = 5 * 1024 * 1024; // 5 Mo
            
            if (fileSize > maxSize) {
                e.preventDefault();
                alert('Le fichier est trop volumineux. La taille maximale autorisée est de 5 Mo.');
                return;
            }
            
            // Vérifier le type du fichier
            const fileName = receiptInput.files[0].name;
            const fileExt = fileName.split('.').pop().toLowerCase();
            const allowedExts = ['pdf', 'jpg', 'jpeg', 'png'];
            
            if (!allowedExts.includes(fileExt)) {
                e.preventDefault();
                alert('Type de fichier non autorisé. Seuls les formats PDF, JPEG et PNG sont acceptés.');
                return;
            }
        }
        
        // Validation de la date (pas de date future)
        const dateInput = document.getElementById('expense_date');
        const selectedDate = new Date(dateInput.value);
        const today = new Date();

        // Reset time parts for both dates to compare dates only
        selectedDate.setHours(0, 0, 0, 0);
        today.setHours(0, 0, 0, 0);

        if (selectedDate > today) {
            e.preventDefault();
            alert('La date de dépense ne peut pas être dans le futur.');
            return;
        }
        
        // Validation du montant (positif)
        const amountInput = document.getElementById('amount');
        if (parseFloat(amountInput.value) <= 0) {
            e.preventDefault();
            alert('Le montant doit être supérieur à zéro.');
            return;
        }
    });
    
    // Calcul automatique de la TVA
    const amountInput = document.getElementById('amount');
    const vatRateSelect = document.getElementById('vat_rate');
    const vatAmountInput = document.getElementById('vat_amount');
    
    function calculateVAT() {
        const amount = parseFloat(amountInput.value) || 0;
        const rate = parseFloat(vatRateSelect.value) || 0;
        
        // Calculer la TVA: montant * taux / (100 + taux)
        if (amount > 0 && rate > 0) {
            const vatAmount = (amount * rate / (100 + rate)).toFixed(2);
            vatAmountInput.value = vatAmount;
        }
    }
    
    vatRateSelect.addEventListener('change', calculateVAT);
    amountInput.addEventListener('change', calculateVAT);
    amountInput.addEventListener('input', calculateVAT);
});
</script>
{% endblock %}