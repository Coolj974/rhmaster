{% extends 'base.html' %}

{% block extra_css %}
<style>
    .password-card {
        border-radius: 0.75rem;
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .password-header {
        background: linear-gradient(135deg, #4e73df, #224abe);
        color: white;
        border-radius: 0.75rem 0.75rem 0 0;
        padding: 1.5rem;
    }
    
    .form-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #5a5c69;
        margin-bottom: 0.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .input-group-text {
        background-color: #f8f9fc;
        border: 1px solid #d1d3e2;
        border-right: none;
    }
    
    .form-control {
        border: 1px solid #d1d3e2;
        border-left: none;
    }
    
    .input-group-text i {
        color: #4e73df;
    }
    
    .password-field {
        position: relative;
    }
    
    .toggle-password {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #4e73df;
        cursor: pointer;
        padding: 0.5rem;
        z-index: 10;
    }
    
    .password-strength {
        height: 5px;
        margin-top: 0.5rem;
        border-radius: 3px;
        background-color: #e3e6f0;
        overflow: hidden;
    }
    
    .password-strength-bar {
        height: 100%;
        width: 0;
        border-radius: 3px;
        transition: all 0.3s;
    }
    
    .strength-weak { width: 25%; background-color: #e74a3b; }
    .strength-medium { width: 50%; background-color: #f6c23e; }
    .strength-good { width: 75%; background-color: #1cc88a; }
    .strength-strong { width: 100%; background-color: #1cc88a; }
    
    .password-hint {
        display: none;
        font-size: 0.8rem;
        color: #5a5c69;
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.25rem;
        background-color: #f8f9fc;
        border: 1px solid #e3e6f0;
    }
    
    .password-hint ul {
        margin-bottom: 0;
        padding-left: 1.5rem;
    }
    
    .switch-container {
        margin-bottom: 1.5rem;
    }
    
    .form-switch .form-check-input {
        width: 2.5em;
        height: 1.25em;
    }
    
    .form-switch .form-check-input:checked {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    .form-check-label {
        font-weight: 600;
        color: #5a5c69;
    }
    
    .category-badge {
        font-size: 0.75rem;
        padding: 0.35rem 0.75rem;
        border-radius: 50rem;
        background-color: rgba(255, 255, 255, 0.2);
        margin-left: 0.5rem;
        display: inline-block;
    }
    
    .btn-action {
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-action:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .btn-save {
        background-color: #4e73df;
        color: white;
        border: none;
    }
    
    .btn-cancel {
        background-color: #f8f9fc;
        color: #5a5c69;
        border: 1px solid #d1d3e2;
    }
    
    .btn-cancel:hover {
        background-color: #eaecf4;
    }
    
    .password-generator-controls {
        display: none;
    }
    
    .password-generator-controls.visible {
        display: block;
        animation: fadeIn 0.3s;
    }
    
    .length-slider {
        width: 100%;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="password-card mb-4">
                <div class="password-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">{{ title }}</h3>
                        {% if is_add %}
                        <span class="category-badge">Nouveau</span>
                        {% endif %}
                    </div>
                    <div>
                        <a href="{% url 'password_manager' %}" class="btn btn-sm btn-light">
                            <i class="fas fa-arrow-left me-1"></i> Retour
                        </a>
                    </div>
                </div>
                
                <div class="card-body p-4">
                    {% if messages %}
                    <div class="mb-4">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="id_title" class="form-label">Titre</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-bookmark"></i></span>
                                {{ form.title }}
                            </div>
                            {% if form.title.errors %}
                            <div class="text-danger small mt-1">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_username" class="form-label">Nom d'utilisateur</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                {{ form.username }}
                            </div>
                            {% if form.username.errors %}
                            <div class="text-danger small mt-1">{{ form.username.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_password" class="form-label">Mot de passe</label>
                            <div class="input-group password-field">
                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                {{ form.password }}
                                <button type="button" id="toggle-password" class="toggle-password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            {% if form.password.errors %}
                            <div class="text-danger small mt-1">{{ form.password.errors }}</div>
                            {% endif %}
                            <div class="password-strength">
                                <div class="password-strength-bar" id="password-strength-bar"></div>
                            </div>
                            <div class="password-hint" id="password-hint">
                                <div class="mb-1">Pour un mot de passe fort, incluez :</div>
                                <ul>
                                    <li id="length-check">Au moins 12 caractères</li>
                                    <li id="uppercase-check">Au moins une majuscule</li>
                                    <li id="lowercase-check">Au moins une minuscule</li>
                                    <li id="number-check">Au moins un chiffre</li>
                                    <li id="special-check">Au moins un caractère spécial</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="switch-container">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="id_generate_password" name="generate_password">
                                <label class="form-check-label" for="id_generate_password">
                                    <i class="fas fa-magic me-1"></i> Générer un mot de passe sécurisé
                                </label>
                            </div>
                            
                            <div class="password-generator-controls mt-3 p-3 bg-light rounded" id="password-generator">
                                <div class="mb-3">
                                    <label for="id_password_length" class="form-label d-flex justify-content-between">
                                        <span>Longueur: <span id="length-value">16</span> caractères</span>
                                    </label>
                                    <input type="range" class="form-range length-slider" min="8" max="32" value="16" id="id_password_length" name="password_length">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include-uppercase" checked>
                                        <label class="form-check-label" for="include-uppercase">
                                            Inclure des majuscules (A-Z)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include-numbers" checked>
                                        <label class="form-check-label" for="include-numbers">
                                            Inclure des chiffres (0-9)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="include-symbols" checked>
                                        <label class="form-check-label" for="include-symbols">
                                            Inclure des caractères spéciaux (!@#$%^&*)
                                        </label>
                                    </div>
                                </div>
                                <button type="button" id="generate-password" class="btn btn-primary">
                                    <i class="fas fa-sync-alt me-1"></i> Générer
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="id_url" class="form-label">URL (facultatif)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-globe"></i></span>
                                {{ form.url }}
                            </div>
                            {% if form.url.errors %}
                            <div class="text-danger small mt-1">{{ form.url.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_notes" class="form-label">Notes (facultatif)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-sticky-note"></i></span>
                                {{ form.notes }}
                            </div>
                            {% if form.notes.errors %}
                            <div class="text-danger small mt-1">{{ form.notes.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="id_category" class="form-label">Catégorie</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-folder"></i></span>
                                {{ form.category }}
                            </div>
                            {% if form.category.errors %}
                            <div class="text-danger small mt-1">{{ form.category.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'password_manager' %}" class="btn btn-action btn-cancel">
                                <i class="fas fa-times me-1"></i> Annuler
                            </a>
                            <button type="submit" class="btn btn-action btn-save">
                                <i class="fas fa-save me-1"></i> Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Afficher/masquer le mot de passe
    const togglePasswordBtn = document.getElementById('toggle-password');
    const passwordField = document.getElementById('id_password');
    
    togglePasswordBtn.addEventListener('click', function() {
        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            togglePasswordBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
            passwordField.type = 'password';
            togglePasswordBtn.innerHTML = '<i class="fas fa-eye"></i>';
        }
    });
    
    // Évaluation de la force du mot de passe
    const passwordStrengthBar = document.getElementById('password-strength-bar');
    const passwordHint = document.getElementById('password-hint');
    
    passwordField.addEventListener('focus', function() {
        passwordHint.style.display = 'block';
    });
    
    passwordField.addEventListener('blur', function() {
        if (!this.value) {
            passwordHint.style.display = 'none';
        }
    });
    
    passwordField.addEventListener('input', function() {
        const password = this.value;
        
        // Vérifier les critères
        const hasLength = password.length >= 12;
        const hasUppercase = /[A-Z]/.test(password);
        const hasLowercase = /[a-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasSpecial = /[^A-Za-z0-9]/.test(password);
        
        // Mettre à jour les indicateurs visuels
        document.getElementById('length-check').style.color = hasLength ? '#1cc88a' : '';
        document.getElementById('uppercase-check').style.color = hasUppercase ? '#1cc88a' : '';
        document.getElementById('lowercase-check').style.color = hasLowercase ? '#1cc88a' : '';
        document.getElementById('number-check').style.color = hasNumber ? '#1cc88a' : '';
        document.getElementById('special-check').style.color = hasSpecial ? '#1cc88a' : '';
        
        // Calculer la force du mot de passe (simple)
        let strength = 0;
        if (password.length > 0) strength += 1;
        if (password.length >= 8) strength += 1;
        if (password.length >= 12) strength += 1;
        if (hasUppercase) strength += 1;
        if (hasLowercase) strength += 1;
        if (hasNumber) strength += 1;
        if (hasSpecial) strength += 1;
        
        // Mettre à jour la barre de force
        passwordStrengthBar.className = 'password-strength-bar';
        if (password.length === 0) {
            passwordStrengthBar.style.width = '0';
        } else if (strength < 3) {
            passwordStrengthBar.classList.add('strength-weak');
        } else if (strength < 5) {
            passwordStrengthBar.classList.add('strength-medium');
        } else if (strength < 7) {
            passwordStrengthBar.classList.add('strength-good');
        } else {
            passwordStrengthBar.classList.add('strength-strong');
        }
    });
    
    // Générateur de mot de passe
    const generatePasswordCheckbox = document.getElementById('id_generate_password');
    const passwordGenerator = document.getElementById('password-generator');
    const generatePasswordBtn = document.getElementById('generate-password');
    const passwordLengthSlider = document.getElementById('id_password_length');
    const passwordLengthValue = document.getElementById('length-value');
    
    generatePasswordCheckbox.addEventListener('change', function() {
        if (this.checked) {
            passwordGenerator.classList.add('visible');
            // Générer un mot de passe immédiatement
            generatePassword();
        } else {
            passwordGenerator.classList.remove('visible');
        }
    });
    
    passwordLengthSlider.addEventListener('input', function() {
        passwordLengthValue.textContent = this.value;
    });
    
    generatePasswordBtn.addEventListener('click', generatePassword);
    
    function generatePassword() {
        const length = passwordLengthSlider.value;
        const includeUppercase = document.getElementById('include-uppercase').checked;
        const includeNumbers = document.getElementById('include-numbers').checked;
        const includeSymbols = document.getElementById('include-symbols').checked;
        
        let charset = 'abcdefghijklmnopqrstuvwxyz';
        if (includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (includeNumbers) charset += '0123456789';
        if (includeSymbols) charset += '!@#$%^&*()-_=+[]{}|;:,.<>?';
        
        let password = '';
        for (let i = 0; i < length; i++) {
            const randomIndex = Math.floor(Math.random() * charset.length);
            password += charset[randomIndex];
        }
        
        passwordField.type = 'text';
        passwordField.value = password;
        togglePasswordBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        
        // Déclencher l'événement input pour mettre à jour la barre de force
        const inputEvent = new Event('input', { bubbles: true });
        passwordField.dispatchEvent(inputEvent);
    }
});
</script>
{% endblock %}
