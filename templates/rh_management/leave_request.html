{% extends "base.html" %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<style>
    /* Styles pour le calendrier */
    #calendar {
        margin-top: 20px;
        font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    /* En-têtes du calendrier */
    .fc-header-toolbar {
        margin-bottom: 1.5em !important;
    }
    
    .fc-toolbar-title {
        font-size: 1.5em !important;
        font-weight: 700 !important;
        color: #4e73df !important;
    }
    
    /* Jours de la semaine */
    .fc-col-header-cell {
        background-color: #f8f9fc;
        font-weight: 600 !important;
        padding: 10px 0 !important;
    }
    
    /* Cellules des jours */
    .fc-daygrid-day {
        transition: background-color 0.2s ease;
    }
    
    .fc-daygrid-day:hover {
        background-color: rgba(78, 115, 223, 0.05);
    }
    
    .fc-day-today {
        background-color: rgba(78, 115, 223, 0.1) !important;
    }
    
    /* Événements du calendrier */
    .fc-event {
        cursor: pointer;
        padding: 6px 10px !important;
        border-radius: 6px !important;
        font-size: 0.85em !important;
        font-weight: 600 !important;
        margin: 2px 0 !important;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .fc-event:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* Styles spécifiques par type d'événement */
    .leave-pending {
        background-color: #f6c23e !important;
        border-color: #f6c23e !important;
        color: #fff !important;
        border-left: 4px solid #e0a800 !important;
    }
    
    .leave-approved {
        background-color: #1cc88a !important;
        border-color: #1cc88a !important;
        color: #fff !important;
        border-left: 4px solid #169b6b !important;
    }
    
    .leave-rejected {
        background-color: #e74a3b !important;
        border-color: #e74a3b !important;
        color: #fff !important;
        border-left: 4px solid #be3e32 !important;
    }
    
    /* Indicateur de nombre d'événements supplémentaires */
    .fc-daygrid-more-link {
        color: #4e73df !important;
        font-weight: 600;
        background-color: rgba(78, 115, 223, 0.1);
        padding: 2px 5px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .fc-daygrid-more-link:hover {
        background-color: rgba(78, 115, 223, 0.2);
    }
    
    /* Boutons du calendrier */
    .fc-button {
        background-color: #4e73df !important;
        border-color: #4e73df !important;
        font-weight: 600 !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        transition: all 0.2s !important;
    }
    
    .fc-button:hover {
        background-color: #2653d4 !important;
        border-color: #2653d4 !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    
    .fc-button-active {
        background-color: #2653d4 !important;
        border-color: #2653d4 !important;
    }
    
    /* Classes pour le tooltip personnalisé */
    .leave-tooltip {
        position: absolute;
        z-index: 10000;
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        max-width: 320px;
        font-size: 0.9em;
        border-top: 4px solid #4e73df;
        animation: tooltipFadeIn 0.2s ease-out;
    }
    
    @keyframes tooltipFadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .leave-tooltip-header {
        border-bottom: 1px solid #e3e6f0;
        padding-bottom: 8px;
        margin-bottom: 10px;
        font-weight: 700;
        color: #4e73df;
        font-size: 1.1em;
    }
    
    .leave-tooltip-close {
        position: absolute;
        top: 8px;
        right: 8px;
        cursor: pointer;
        font-size: 0.9em;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: #f8f9fc;
        transition: background-color 0.2s;
    }
    
    .leave-tooltip-close:hover {
        background-color: #eaecf4;
    }
    
    /* Styles du toggle switch */
    .form-check-input {
        cursor: pointer;
    }
    
    .form-check-input:checked {
        background-color: #4e73df;
        border-color: #4e73df;
    }
    
    /* Styles pour les boutons de vue */
    .btn-outline-primary {
        color: #4e73df;
        border-color: #4e73df;
    }
    
    .btn-outline-primary:hover {
        background-color: #4e73df;
        border-color: #4e73df;
        color: white;
    }
    
    /* Animation pour les cards et éléments */
    .card {
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* Indications de durée de congé */
    #leave-duration {
        background: linear-gradient(45deg, rgba(78, 115, 223, 0.1), rgba(78, 115, 223, 0.05));
        border-left: 3px solid #4e73df;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 0.9em;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .fc-toolbar-title {
            font-size: 1.2em !important;
        }
        
        .fc-button {
            padding: 0.3em 0.6em !important;
            font-size: 0.9em !important;
        }
        
        .leave-tooltip {
            max-width: 90%;
        }
    }
    
    /* Amélioration de la légende */
    .calendar-legend {
        display: flex;
        justify-content: center;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin: 0 10px 10px;
        padding: 5px 10px;
        border-radius: 20px;
        background-color: rgba(0,0,0,0.03);
        transition: background-color 0.2s;
    }
    
    .legend-item:hover {
        background-color: rgba(0,0,0,0.06);
    }
    
    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        margin-right: 8px;
    }
    
    .legend-label {
        font-size: 0.85em;
        font-weight: 600;
    }

    /* Bouton gradient pour la soumission de demande */
    .btn-gradient-primary {
        background: linear-gradient(45deg, #4e73df, #224abe) !important;
        color: white !important;
        border: none !important;
        transition: all 0.3s !important;
    }

    .btn-gradient-primary:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 5px 15px rgba(78, 115, 223, 0.3) !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- Formulaire de demande de congé -->
        <div class="col-md-5">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-4 animate-fade-in">
                <div class="card-header bg-gradient-primary text-white p-4">
                    <h3 class="mb-0"><i class="fas fa-calendar-plus me-2"></i> Demande de congé</h3>
                </div>
                <div class="card-body p-4">
                    <!-- Remplacer la classe alert par balance-info pour éviter la disparition automatique -->
                    <div class="balance-info bg-light mb-4 p-3 rounded-3 border-start border-4 border-info">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle fa-2x text-info"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="fw-bold text-info">Solde de congés</h5>
                                <p class="mb-0">Jours disponibles: <span class="fw-bold">{{ leave_balance.available }}</span> sur {{ leave_balance.acquired }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Champ Type de congé -->
                        <div class="mb-3">
                            <label for="{{ form.leave_type.id_for_label }}" class="form-label">Type de congé <span class="text-danger">*</span></label>
                            {{ form.leave_type }}
                        </div>
                        
                        <!-- Dates de début et de fin -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.start_date.id_for_label }}" class="form-label">Date de début <span class="text-danger">*</span></label>
                                    {{ form.start_date }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.end_date.id_for_label }}" class="form-label">Date de fin <span class="text-danger">*</span></label>
                                    {{ form.end_date }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Champ Motif -->
                        <div class="mb-3">
                            <label for="{{ form.reason.id_for_label }}" class="form-label">Motif</label>
                            {{ form.reason }}
                        </div>
                        
                        <!-- Champ Pièce jointe -->
                        <div class="mb-3">
                            <label for="{{ form.attachment.id_for_label }}" class="form-label">Pièce jointe</label>
                            {{ form.attachment }}
                            <small class="form-text text-muted">Vous pouvez joindre un justificatif (optionnel)</small>
                        </div>
                        
                        <!-- Champ Email de notification -->
                        <div class="mb-3">
                            <label for="{{ form.notification_emails.id_for_label }}" class="form-label">Envoyer une notification à</label>
                            {{ form.notification_emails }}
                        </div>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-gradient-primary w-100 py-2 rounded-pill">
                                <i class="fas fa-paper-plane me-2"></i>Soumettre la demande
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Calendrier des congés -->
        <div class="col-md-7">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-4 animate-fade-in">
                <div class="card-header bg-gradient-info text-white p-4">
                    <h3 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> Calendrier des congés</h3>
                </div>
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="show-all-leaves" checked>
                            <label class="form-check-label" for="show-all-leaves">
                                Afficher les congés de tous les employés
                            </label>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="month-view">Mois</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="week-view">Semaine</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="day-view">Jour</button>
                        </div>
                    </div>
                    <div id="calendar"></div>
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f6c23e;"></div>
                            <span class="legend-label">En attente</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #1cc88a;"></div>
                            <span class="legend-label">Approuvé</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e74a3b;"></div>
                            <span class="legend-label">Refusé</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dernières demandes -->
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden animate-fade-in">
                <div class="card-header bg-gradient-secondary text-white p-4">
                    <h3 class="mb-0"><i class="fas fa-history me-2"></i> Historique récent</h3>
                </div>
                <div class="card-body p-4">
                    {% if recent_leaves %}
                        <div class="list-group">
                            {% for leave in recent_leaves %}
                                <div class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ leave.get_leave_type_display }}</h5>
                                        <small class="badge bg-{% if leave.status == 'approved' %}success{% elif leave.status == 'rejected' %}danger{% else %}warning{% endif %} text-white">
                                            {{ leave.get_status_display }}
                                        </small>
                                    </div>
                                    <p class="mb-1">
                                        <i class="fas fa-calendar-alt me-1 text-primary"></i> 
                                        Du {{ leave.start_date|date:"d/m/Y" }} au {{ leave.end_date|date:"d/m/Y" }}
                                    </p>
                                    {% if leave.reason %}
                                        <small class="text-muted">
                                            <i class="fas fa-comment me-1"></i> {{ leave.reason }}
                                        </small>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <p class="mb-0">Vous n'avez pas encore effectué de demande de congé.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Élément pour les tooltips -->
<div id="leave-tooltip" class="leave-tooltip" style="display: none;">
    <span class="leave-tooltip-close"><i class="fas fa-times"></i></span>
    <div class="leave-tooltip-header" id="tooltip-title"></div>
    <div id="tooltip-body"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialisation du calendrier
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'fr',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            firstDay: 1, // Lundi comme premier jour de la semaine
            dayMaxEvents: true, // Afficher "plus" quand il y a beaucoup d'événements
            events: function(info, successCallback, failureCallback) {
                // Récupérer les congés depuis l'API
                fetch('/api/leaves/?start=' + info.startStr + '&end=' + info.endStr + '&all=' + (document.getElementById('show-all-leaves').checked ? 'true' : 'false'))
                    .then(response => response.json())
                    .then(data => {
                        // Transforme les données en événements pour le calendrier
                        const events = data.map(leave => {
                            let statusClass = 'leave-pending';
                            if (leave.status === 'approved') statusClass = 'leave-approved';
                            if (leave.status === 'rejected') statusClass = 'leave-rejected';
                            
                            return {
                                id: leave.id,
                                title: leave.title,
                                start: leave.start_date,
                                end: leave.end_date,
                                allDay: true,
                                classNames: [statusClass],
                                extendedProps: {
                                    user: leave.user,
                                    leaveType: leave.leave_type,
                                    status: leave.status,
                                    reason: leave.reason
                                }
                            };
                        });
                        
                        successCallback(events);
                    })
                    .catch(error => {
                        console.error('Error fetching leave data:', error);
                        failureCallback(error);
                    });
            },
            eventClick: function(info) {
                // Afficher les détails d'un congé dans un tooltip
                showLeaveTooltip(info.event, info.jsEvent);
            }
        });
        
        calendar.render();
        
        // Boutons pour changer de vue
        document.getElementById('month-view').addEventListener('click', function() {
            calendar.changeView('dayGridMonth');
        });
        
        document.getElementById('week-view').addEventListener('click', function() {
            calendar.changeView('timeGridWeek');
        });
        
        document.getElementById('day-view').addEventListener('click', function() {
            calendar.changeView('timeGridDay');
        });
        
        // Filtre pour afficher tous les congés ou juste ceux de l'utilisateur
        document.getElementById('show-all-leaves').addEventListener('change', function() {
            calendar.refetchEvents();
        });
        
        // Gestion des tooltips
        function showLeaveTooltip(event, jsEvent) {
            const tooltip = document.getElementById('leave-tooltip');
            const title = document.getElementById('tooltip-title');
            const body = document.getElementById('tooltip-body');
            
            // Définir le contenu du tooltip
            title.innerHTML = event.title;
            
            let statusText = "En attente";
            let statusClass = "text-warning";
            if (event.extendedProps.status === 'approved') {
                statusText = "Approuvé";
                statusClass = "text-success";
            } else if (event.extendedProps.status === 'rejected') {
                statusText = "Refusé";
                statusClass = "text-danger";
            }
            
            body.innerHTML = `
                <p><strong>Employé:</strong> ${event.extendedProps.user}</p>
                <p><strong>Période:</strong> ${formatDate(event.start)} - ${formatDate(event.end || event.start)}</p>
                <p><strong>Type:</strong> ${event.extendedProps.leaveType}</p>
                <p><strong>Statut:</strong> <span class="${statusClass}">${statusText}</span></p>
                ${event.extendedProps.reason ? `<p><strong>Motif:</strong> ${event.extendedProps.reason}</p>` : ''}
            `;
            
            // Positionner le tooltip
            tooltip.style.left = jsEvent.pageX + 10 + 'px';
            tooltip.style.top = jsEvent.pageY + 10 + 'px';
            tooltip.style.display = 'block';
            
            // Fermer le tooltip
            document.querySelector('.leave-tooltip-close').addEventListener('click', function() {
                tooltip.style.display = 'none';
            });
            
            // Fermer le tooltip en cliquant ailleurs
            document.addEventListener('click', function closeTooltip(e) {
                if (!tooltip.contains(e.target) && e.target !== jsEvent.target) {
                    tooltip.style.display = 'none';
                    document.removeEventListener('click', closeTooltip);
                }
            });
        }
        
        // Format de date
        function formatDate(date) {
            if (!date) return '';
            
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(date).toLocaleDateString('fr-FR', options);
        }
    });
    
    // Calcul de la durée du congé
    document.addEventListener('DOMContentLoaded', function() {
        const startDateInput = document.getElementById('id_start_date');
        const endDateInput = document.getElementById('id_end_date');
        
        function calculateDuration() {
            if (startDateInput.value && endDateInput.value) {
                const start = new Date(startDateInput.value);
                const end = new Date(endDateInput.value);
                
                // Vérifier que la date de fin est après la date de début
                if (end < start) {
                    endDateInput.value = startDateInput.value;
                    return;
                }
                
                // Calculer la durée en jours
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 car on compte les deux jours
                
                if (diffDays) {
                    const durationElement = document.getElementById('leave-duration');
                    if (!durationElement) {
                        const durationInfo = document.createElement('div');
                        durationInfo.className = 'alert alert-light mt-2';
                        durationInfo.id = 'leave-duration';
                        durationInfo.innerHTML = `<small><i class="fas fa-info-circle me-1"></i> Durée: <strong>${diffDays} jour(s)</strong></small>`;
                        endDateInput.parentNode.appendChild(durationInfo);
                    } else {
                        durationElement.innerHTML = `<small><i class="fas fa-info-circle me-1"></i> Durée: <strong>${diffDays} jour(s)</strong></small>`;
                    }
                }
            }
        }
        
        startDateInput.addEventListener('change', calculateDuration);
        endDateInput.addEventListener('change', calculateDuration);
    });
</script>
{% endblock %}